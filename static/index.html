<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>External Merge Sort — Visualizer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
/* ── Reset & Base ─────────────────────────────────────────── */
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:       #080c14;
  --surface:  #0d1422;
  --card:     #111926;
  --border:   rgba(255,255,255,0.06);
  --text:     #dde6f0;
  --muted:    #5a7090;
  --cyan:     #00d4ff;
  --violet:   #8b5cf6;
  --green:    #22d3a0;
  --orange:   #f59e0b;
  --red:      #f43f5e;
  --font-mono:'Space Mono', monospace;
  --font-body:'DM Sans', sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-body)}

/* ── Noise overlay ────────────────────────────────────────── */
body::before{
  content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:.4
}

/* ── Layout ──────────────────────────────────────────────── */
.app{position:relative;z-index:1;min-height:100vh;display:grid;grid-template-rows:auto 1fr;padding:24px;gap:20px;max-width:1400px;margin:0 auto}

/* ── Header ──────────────────────────────────────────────── */
header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.brand{display:flex;align-items:baseline;gap:12px}
.brand-title{font-family:var(--font-mono);font-size:18px;font-weight:700;letter-spacing:-.5px;color:#fff}
.brand-tag{font-family:var(--font-mono);font-size:11px;color:var(--cyan);border:1px solid var(--cyan);padding:2px 8px;border-radius:4px;opacity:.7}
.upload-zone{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* file picker hidden, custom label */
#fileInput{display:none}
.file-label{
  display:flex;align-items:center;gap:8px;
  padding:8px 14px;border-radius:8px;
  border:1px solid var(--border);background:var(--card);
  cursor:pointer;font-size:13px;color:var(--muted);
  transition:border-color .2s,color .2s
}
.file-label:hover{border-color:var(--cyan);color:var(--text)}
.file-label svg{flex-shrink:0;opacity:.6}
#fileNameDisplay{font-size:12px;color:var(--muted);max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.btn{
  display:inline-flex;align-items:center;gap:7px;
  padding:8px 16px;border-radius:8px;border:none;
  font-family:var(--font-body);font-size:13px;font-weight:500;
  cursor:pointer;transition:opacity .15s,transform .1s
}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--cyan),var(--violet));color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{border-color:var(--border);color:var(--text)}
.btn:disabled{opacity:.35;cursor:not-allowed;pointer-events:none}
.btn-dl{background:rgba(34,211,160,.12);border:1px solid rgba(34,211,160,.25);color:var(--green)}

/* ── Main grid ───────────────────────────────────────────── */
.main{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}

/* ── Stage (left) ────────────────────────────────────────── */
.stage{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;display:flex;flex-direction:column;gap:20px;min-height:600px}

.stage-header{display:flex;align-items:center;justify-content:space-between}
.stage-title{font-family:var(--font-mono);font-size:12px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
.phase-badge{
  font-family:var(--font-mono);font-size:11px;
  padding:3px 10px;border-radius:20px;
  background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);color:var(--cyan)
}

/* ── Empty / loading state ───────────────────────────────── */
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;opacity:.35}
.empty-state svg{opacity:.4}
.empty-state p{font-size:13px;color:var(--muted);font-family:var(--font-mono)}

/* ── Phase sections ──────────────────────────────────────── */
.phase-section{border-left:2px solid var(--border);padding-left:16px;display:flex;flex-direction:column;gap:12px}
.phase-section.active{border-left-color:var(--cyan)}
.phase-label{font-family:var(--font-mono);font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px}

/* ── Run cards ───────────────────────────────────────────── */
.runs-row{display:flex;gap:10px;flex-wrap:wrap}
.run-card{
  background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:10px 12px;min-width:140px;max-width:200px;
  transition:border-color .25s
}
.run-card.active-run{border-color:var(--cyan)}
.run-card.sorted{border-color:rgba(34,211,160,.4)}
.run-card-title{font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-bottom:8px}
.run-bars{display:flex;align-items:flex-end;gap:2px;height:48px;overflow:hidden}
.run-bar{
  flex:1;min-width:4px;max-width:12px;
  border-radius:2px 2px 0 0;
  background:rgba(0,212,255,.5);
  transition:height .35s cubic-bezier(.2,.9,.3,1),background .3s
}
.run-bar.highlight{background:var(--orange)}
.run-card.sorted .run-bar{background:rgba(34,211,160,.6)}

/* ── Heap area ───────────────────────────────────────────── */
.heap-area{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
.heap-area-title{font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.08em}
.heap-nodes{display:flex;gap:6px;flex-wrap:wrap;min-height:44px;align-items:center}
.heap-node{
  font-family:var(--font-mono);font-size:11px;
  padding:5px 9px;border-radius:6px;
  background:linear-gradient(135deg,rgba(245,158,11,.18),rgba(244,63,94,.18));
  border:1px solid rgba(245,158,11,.25);
  color:var(--orange);
  opacity:0;transform:translateY(6px);
  transition:opacity .22s,transform .22s
}
.heap-node.visible{opacity:1;transform:translateY(0)}
.heap-node.popping{opacity:0;transform:translateY(-10px) scale(.88)}

/* ── Output strip ────────────────────────────────────────── */
.output-area{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
.output-nodes{display:flex;gap:4px;flex-wrap:wrap;min-height:36px;align-items:center}
.out-node{
  font-family:var(--font-mono);font-size:10px;
  padding:3px 7px;border-radius:5px;
  background:rgba(34,211,160,.1);border:1px solid rgba(34,211,160,.2);color:var(--green);
  opacity:0;transform:scale(.8);
  transition:opacity .2s,transform .2s
}
.out-node.visible{opacity:1;transform:scale(1)}

/* ── Sidebar ─────────────────────────────────────────────── */
.sidebar{display:flex;flex-direction:column;gap:14px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px}
.card-title{font-family:var(--font-mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:12px}

/* stats grid */
.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat{background:var(--card);border-radius:8px;padding:10px 12px}
.stat-label{font-size:11px;color:var(--muted);margin-bottom:4px}
.stat-val{font-family:var(--font-mono);font-size:18px;font-weight:700;color:#fff}
.stat-val.cyan{color:var(--cyan)}
.stat-val.violet{color:var(--violet)}

/* progress */
.progress-wrap{margin-top:4px}
.progress-label{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:6px}
.progress-track{height:6px;background:rgba(255,255,255,.05);border-radius:6px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--violet));border-radius:6px;width:0%;transition:width .3s}

/* controls */
.ctrl-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.speed-wrap{display:flex;align-items:center;gap:8px;margin-top:8px}
.speed-wrap label{font-size:11px;color:var(--muted);white-space:nowrap;font-family:var(--font-mono)}
input[type=range]{
  flex:1;-webkit-appearance:none;height:4px;
  background:rgba(255,255,255,.08);border-radius:4px;outline:none
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:14px;height:14px;
  border-radius:50%;background:var(--cyan);cursor:pointer
}

/* log */
.log-list{font-family:var(--font-mono);font-size:11px;color:var(--muted);display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto}
.log-list::-webkit-scrollbar{width:4px}
.log-list::-webkit-scrollbar-track{background:transparent}
.log-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.log-entry{display:flex;gap:8px;line-height:1.4}
.log-time{opacity:.4;flex-shrink:0}
.log-entry.info .log-msg{color:var(--cyan)}
.log-entry.warn .log-msg{color:var(--orange)}
.log-entry.ok .log-msg{color:var(--green)}

/* hint */
.hints{display:flex;gap:8px;flex-wrap:wrap}
.hint{font-size:11px;color:var(--muted)}
.hint kbd{
  font-family:var(--font-mono);background:var(--card);
  border:1px solid var(--border);border-radius:4px;
  padding:1px 6px;font-size:10px;color:var(--text)
}

/* ── Spinner ──────────────────────────────────────────────── */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .7s linear infinite;display:none}
.spinner.active{display:block}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Responsive ───────────────────────────────────────────── */
@media(max-width:860px){
  .main{grid-template-columns:1fr}
  .sidebar{flex-direction:row;flex-wrap:wrap}
  .card{flex:1 1 260px}
}
</style>
</head>
<body>
<div class="app">

  <!-- ── Header ── -->
  <header>
    <div class="brand">
      <span class="brand-title">ext_merge_sort</span>
      <span class="brand-tag">VISUALIZER</span>
    </div>
    <div class="upload-zone">
      <input type="file" id="fileInput" accept=".bin"/>
      <label class="file-label" for="fileInput">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Chọn file .bin
      </label>
      <span id="fileNameDisplay">Chưa chọn file</span>
      <div class="spinner" id="spinner"></div>
      <button class="btn btn-primary" id="uploadBtn" disabled>Visualize</button>
      <button class="btn btn-dl" id="downloadBtn" style="display:none">↓ Download sorted</button>
    </div>
  </header>

  <!-- ── Main ── -->
  <div class="main">

    <!-- Stage -->
    <div class="stage" id="stage">
      <div class="stage-header">
        <span class="stage-title">Visualization Stage</span>
        <span class="phase-badge" id="phaseBadge">Waiting...</span>
      </div>

      <div class="empty-state" id="emptyState">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
          <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
        </svg>
        <p>Upload file .bin để bắt đầu visualize</p>
      </div>

      <!-- Dynamically populated -->
      <div id="stageContent" style="display:none;flex-direction:column;gap:20px"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">

      <!-- Stats -->
      <div class="card">
        <div class="card-title">Thông số</div>
        <div class="stats">
          <div class="stat">
            <div class="stat-label">k-way</div>
            <div class="stat-val cyan" id="statK">—</div>
          </div>
          <div class="stat">
            <div class="stat-label">block_size</div>
            <div class="stat-val violet" id="statB">—</div>
          </div>
          <div class="stat">
            <div class="stat-label">Runs</div>
            <div class="stat-val" id="statRuns">—</div>
          </div>
          <div class="stat">
            <div class="stat-label">Sample</div>
            <div class="stat-val" id="statSample">—</div>
          </div>
        </div>
        <div class="progress-wrap" style="margin-top:12px">
          <div class="progress-label">
            <span>Progress</span>
            <span id="progressText">0 / 0</span>
          </div>
          <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
        </div>
      </div>

      <!-- Playback -->
      <div class="card">
        <div class="card-title">Điều khiển</div>
        <div class="ctrl-row">
          <button class="btn btn-ghost" id="startBtn" disabled>▶ Start</button>
          <button class="btn btn-ghost" id="pauseBtn" disabled>⏸ Pause</button>
          <button class="btn btn-ghost" id="stepBtn" disabled>⏭ Step</button>
        </div>
        <div class="speed-wrap">
          <label>Speed</label>
          <input type="range" id="speedInput" min="0.25" max="4" step="0.25" value="1"/>
          <span style="font-family:var(--font-mono);font-size:11px;color:var(--cyan);min-width:28px" id="speedLabel">1×</span>
        </div>
        <div class="hints" style="margin-top:10px">
          <span class="hint"><kbd>Space</kbd> pause</span>
          <span class="hint"><kbd>→</kbd> step</span>
        </div>
      </div>

      <!-- Log -->
      <div class="card" style="flex:1">
        <div class="card-title">Event Log</div>
        <div class="log-list" id="logList"></div>
      </div>

    </div>
  </div><!-- /main -->
</div><!-- /app -->

<script>
// ── DOM ──────────────────────────────────────────────────────
const fileInput   = document.getElementById('fileInput');
const fileNameDisp= document.getElementById('fileNameDisplay');
const uploadBtn   = document.getElementById('uploadBtn');
const downloadBtn = document.getElementById('downloadBtn');
const spinner     = document.getElementById('spinner');
const phaseBadge  = document.getElementById('phaseBadge');
const emptyState  = document.getElementById('emptyState');
const stageContent= document.getElementById('stageContent');
const statK       = document.getElementById('statK');
const statB       = document.getElementById('statB');
const statRuns    = document.getElementById('statRuns');
const statSample  = document.getElementById('statSample');
const progressFill= document.getElementById('progressFill');
const progressText= document.getElementById('progressText');
const startBtn    = document.getElementById('startBtn');
const pauseBtn    = document.getElementById('pauseBtn');
const stepBtn     = document.getElementById('stepBtn');
const speedInput  = document.getElementById('speedInput');
const speedLabel  = document.getElementById('speedLabel');
const logList     = document.getElementById('logList');

// ── State ─────────────────────────────────────────────────────
let steps = [], idx = 0, paused = true, speed = 1;
let jobId = null;   // từ /sort (download)
let totalSteps = 0;

// current visual state
const runCards = {};   // run_index → {card, bars}
let heapNodesEl = null;
let outputNodesEl = null;
let currentPhaseEl = null;
let currentMergeSection = null;

// ── Logging ───────────────────────────────────────────────────
function log(msg, type=''){
  const entry = document.createElement('div');
  entry.className = 'log-entry' + (type ? ' '+type : '');
  const t = new Date().toLocaleTimeString('vi',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  entry.innerHTML = `<span class="log-time">${t}</span><span class="log-msg">${msg}</span>`;
  logList.prepend(entry);
  while(logList.children.length > 80) logList.removeChild(logList.lastChild);
}

// ── Progress ──────────────────────────────────────────────────
function updateProgress(){
  const pct = totalSteps ? Math.round(idx/totalSteps*100) : 0;
  progressFill.style.width = pct + '%';
  progressText.textContent = `${idx} / ${totalSteps}`;
}

// ── File picker ───────────────────────────────────────────────
fileInput.onchange = () => {
  const f = fileInput.files[0];
  if(!f) return;
  fileNameDisp.textContent = f.name;
  uploadBtn.disabled = false;
};

// ── Upload & Visualize ────────────────────────────────────────
uploadBtn.onclick = async () => {
  const f = fileInput.files[0];
  if(!f){ alert('Chọn file .bin trước'); return; }

  uploadBtn.disabled = true;
  spinner.classList.add('active');
  downloadBtn.style.display = 'none';
  phaseBadge.textContent = 'Uploading...';
  log('Đang upload & sort...', 'info');

  // Upload 1 lần duy nhất → /sort/visualize tự chạy cả visualize lẫn sort thật
  const fd = new FormData();
  fd.append('file', f);
  let vizData;
  try{
    const r = await fetch('/sort/visualize', {method:'POST', body:fd});
    if(!r.ok){
      const err = await r.json().catch(()=>({detail: r.statusText}));
      throw new Error(err.detail || r.statusText);
    }
    vizData = await r.json();
  } catch(e){
    log('Lỗi: ' + e.message, 'warn');
    spinner.classList.remove('active');
    uploadBtn.disabled = false;
    phaseBadge.textContent = 'Error';
    return;
  }

  // Dùng job_id từ response để poll download (sort thật đang chạy background)
  if(vizData.job_id){
    jobId = vizData.job_id;
    log(`Sort thật đang chạy... job=${jobId}`, 'info');
    pollForDownload(jobId);
  }

  // Setup visualization
  steps = vizData.steps || [];
  totalSteps = steps.length;
  idx = 0;
  resetStage();

  const meta   = vizData.meta || steps.find(s=>s.type==='meta');
  const params = steps.find(s=>s.type==='params_chosen');
  if(meta){
    statK.textContent    = meta.k          ?? '—';
    statB.textContent    = meta.block_size ?? '—';
    statRuns.textContent = meta.runs_count ?? '—';
  }
  if(params) statSample.textContent = params.visualize_sample_size ?? '—';

  spinner.classList.remove('active');
  phaseBadge.textContent = 'Ready';
  log(`Nhận ${steps.length} steps. Nhấn Start để xem.`, 'ok');
  updateProgress();

  startBtn.disabled = false;
  stepBtn.disabled  = false;
};

// poll /status cho download — retry không giới hạn cho đến khi done/error
async function pollForDownload(jid){
  // Cập nhật trạng thái lên UI
  const updateDownloadStatus = (msg) => {
    downloadBtn.textContent = msg;
    downloadBtn.style.display = 'inline-flex';
    downloadBtn.style.opacity = '0.5';
    downloadBtn.style.cursor  = 'default';
    downloadBtn.onclick = null;
  };

  const markReady = () => {
    downloadBtn.textContent = '↓ Download sorted';
    downloadBtn.style.opacity = '1';
    downloadBtn.style.cursor  = 'pointer';
    downloadBtn.onclick = () => window.location = `/download/${jid}`;
  };

  updateDownloadStatus('⏳ Đang sort...');

  const doPoll = async () => {
    try{
      const r = await fetch(`/status/${jid}`);
      if(!r.ok){ setTimeout(doPoll, 2000); return; }
      const d = await r.json();

      if(d.status === 'done'){
        markReady();
        log('✓ Sort thật xong — có thể download.', 'ok');
      } else if(d.status && d.status.startsWith('error')){
        downloadBtn.style.display = 'none';
        log('Sort thật lỗi: ' + d.status, 'warn');
      } else {
        // queued hoặc processing → tiếp tục poll
        const label = d.status === 'processing' ? '⏳ Sorting...' : '⏳ Queued...';
        updateDownloadStatus(label);
        setTimeout(doPoll, 1500);
      }
    } catch(e){
      // network error → retry sau 3s
      setTimeout(doPoll, 3000);
    }
  };

  doPoll();
}

// ── Stage reset ───────────────────────────────────────────────
function resetStage(){
  stageContent.innerHTML = '';
  stageContent.style.display = 'flex';
  emptyState.style.display = 'none';
  Object.keys(runCards).forEach(k => delete runCards[k]);
  heapNodesEl = null;
  outputNodesEl = null;
  currentPhaseEl = null;
  currentMergeSection = null;
}

// ── Build DOM helpers ─────────────────────────────────────────

function ensurePhase1Section(){
  if(document.getElementById('phase1-section')) return document.getElementById('phase1-section');
  const sec = document.createElement('div');
  sec.className = 'phase-section active';
  sec.id = 'phase1-section';
  sec.innerHTML = '<div class="phase-label">Phase 1 — Tạo Initial Runs</div>';
  const row = document.createElement('div');
  row.className = 'runs-row';
  row.id = 'phase1-runs';
  sec.appendChild(row);
  stageContent.appendChild(sec);
  return sec;
}

function getOrCreateRunCard(runIdx){
  if(runCards[runIdx]) return runCards[runIdx];
  ensurePhase1Section();
  const row = document.getElementById('phase1-runs');
  const card = document.createElement('div');
  card.className = 'run-card';
  card.id = `run-card-${runIdx}`;
  card.innerHTML = `<div class="run-card-title">Run ${runIdx}</div>
                    <div class="run-bars" id="run-bars-${runIdx}"></div>`;
  row.appendChild(card);
  runCards[runIdx] = { card, barsEl: card.querySelector(`#run-bars-${runIdx}`) };
  return runCards[runIdx];
}

function renderRunBars(barsEl, arr, highlight=false){
  if(!arr || !arr.length){ barsEl.innerHTML=''; return; }
  const max = Math.max(...arr, 1);
  barsEl.innerHTML = arr.map(v=>{
    const h = Math.max(4, Math.round((v/max)*44));
    return `<div class="run-bar${highlight?' highlight':''}" style="height:${h}px"></div>`;
  }).join('');
}

function ensureMergeSection(passId, groupId, inputNames){
  const id = `merge-${passId}-${groupId}`;
  if(document.getElementById(id)) return;

  const sec = document.createElement('div');
  sec.className = 'phase-section active';
  sec.id = id;
  sec.innerHTML = `<div class="phase-label">Pass ${passId} — Group ${groupId}${inputNames?' ('+inputNames.join(', ')+')':''}</div>`;

  // input buffers mini row
  const bufRow = document.createElement('div');
  bufRow.className = 'runs-row';
  bufRow.id = `${id}-bufs`;
  sec.appendChild(bufRow);

  // heap
  const heapWrap = document.createElement('div');
  heapWrap.className = 'heap-area';
  heapWrap.innerHTML = `<div class="heap-area-title">Min-Heap</div><div class="heap-nodes" id="${id}-heap"></div>`;
  sec.appendChild(heapWrap);

  // output
  const outWrap = document.createElement('div');
  outWrap.className = 'output-area';
  outWrap.innerHTML = `<div class="heap-area-title" style="margin-bottom:8px">Output</div><div class="output-nodes" id="${id}-output"></div>`;
  sec.appendChild(outWrap);

  stageContent.appendChild(sec);
  stageContent.scrollTop = stageContent.scrollHeight;

  heapNodesEl = document.getElementById(`${id}-heap`);
  outputNodesEl = document.getElementById(`${id}-output`);
  currentMergeSection = id;
}

function ensureCurrentHeapOutput(){
  if(!currentMergeSection) return;
  heapNodesEl = document.getElementById(`${currentMergeSection}-heap`);
  outputNodesEl = document.getElementById(`${currentMergeSection}-output`);
}

// ── Event processing ──────────────────────────────────────────
function processEvent(ev){
  switch(ev.type){

    case 'params_chosen':
      statK.textContent = ev.k ?? statK.textContent;
      statB.textContent = ev.block_size ?? statB.textContent;
      if(ev.visualize_sample_size) statSample.textContent = ev.visualize_sample_size;
      phaseBadge.textContent = 'Params set';
      break;

    case 'meta':
      statK.textContent   = ev.k ?? statK.textContent;
      statB.textContent   = ev.block_size ?? statB.textContent;
      statRuns.textContent= ev.runs_count ?? statRuns.textContent;
      break;

    case 'file_info':
      log(`File: ${ev.file_name} (${ev.file_size ? (ev.file_size/1024/1024).toFixed(2)+' MB' : '?'})`, 'info');
      break;

    case 'read_block':{
      phaseBadge.textContent = `Phase 1 — Run ${ev.run_index}`;
      const rc = getOrCreateRunCard(ev.run_index);
      rc.card.classList.remove('sorted');
      rc.card.classList.add('active-run');
      renderRunBars(rc.barsEl, ev.sample, true);
      log(`Read block #${ev.run_index} — ${ev.count} phần tử`);
      break;
    }

    case 'sort_block':{
      const rc = getOrCreateRunCard(ev.run_index);
      rc.card.classList.remove('active-run');
      rc.card.classList.add('sorted');
      renderRunBars(rc.barsEl, ev.sorted_sample, false);
      log(`Sorted run #${ev.run_index}`, 'ok');
      break;
    }

    case 'pass_info':
      phaseBadge.textContent = `Merge Pass ${ev.pass_id}`;
      log(`Merge Pass ${ev.pass_id} — ${ev.runs_before} runs, k=${ev.k}`, 'info');
      break;

    case 'merge_start':
      ensureMergeSection(ev.pass_id, ev.group_id, ev.inputs);
      if(ev.input_buffers){
        const bufRow = document.getElementById(`merge-${ev.pass_id}-${ev.group_id}-bufs`);
        if(bufRow){
          bufRow.innerHTML = '';
          ev.input_buffers.forEach((arr, i) => {
            if(!arr || !arr.length) return;
            const card = document.createElement('div');
            card.className = 'run-card active-run';
            card.innerHTML = `<div class="run-card-title">Input ${i}</div>
                              <div class="run-bars" id="mbuf-${ev.pass_id}-${ev.group_id}-${i}"></div>`;
            bufRow.appendChild(card);
            renderRunBars(card.querySelector(`#mbuf-${ev.pass_id}-${ev.group_id}-${i}`), arr);
          });
        }
      }
      if(ev.initial_heap && heapNodesEl){
        heapNodesEl.innerHTML = '';
        ev.initial_heap.forEach(h => {
          const val = Array.isArray(h) ? h[0] : h.value;
          const src = Array.isArray(h) ? h[1] : h.src;
          pushHeapNode(val, src);
        });
      }
      log(`Merge start p${ev.pass_id}g${ev.group_id}`);
      break;

    case 'heap_push':
      ensureCurrentHeapOutput();
      if(heapNodesEl) pushHeapNode(ev.value, ev.src);
      break;

    case 'heap_pop':
      ensureCurrentHeapOutput();
      if(heapNodesEl) popHeapNode(ev.value, ev.src);
      break;

    case 'output_emit':
      ensureCurrentHeapOutput();
      if(outputNodesEl) emitOutput(ev.value);
      break;

    case 'input_buffer_update':
      // update mini input buffer bars
      if(ev.input_buffers && currentMergeSection){
        ev.input_buffers.forEach((arr, i) => {
          const el = document.getElementById(`mbuf-${currentMergeSection.replace('merge-','')}-${i}`);
          if(el) renderRunBars(el, arr);
        });
      }
      break;

    case 'merge_end':
      log(`Merge end p${ev.pass_id}g${ev.group_id} — ${ev.merged_count} phần tử`, 'ok');
      break;

    case 'finished':
      phaseBadge.textContent = '✓ Done';
      log('Visualization hoàn thành!', 'ok');
      // show final sorted preview
      if(ev.final_preview && ev.final_preview.length){
        const finSec = document.createElement('div');
        finSec.className = 'phase-section';
        finSec.style.borderLeftColor = 'var(--green)';
        finSec.innerHTML = '<div class="phase-label" style="color:var(--green)">Output — Sorted</div>';
        const card = document.createElement('div');
        card.className = 'run-card sorted';
        card.style.maxWidth='100%';
        card.innerHTML = `<div class="run-card-title">${ev.final_preview.length} số (preview)</div>
                          <div class="run-bars" id="final-bars" style="height:64px"></div>`;
        finSec.appendChild(card);
        stageContent.appendChild(finSec);
        const barsEl = card.querySelector('#final-bars');
        renderRunBars(barsEl, ev.final_preview.slice(0,60));
        stageContent.scrollTop = stageContent.scrollHeight;
      }
      paused = true;
      pauseBtn.textContent = '⏸ Pause';
      pauseBtn.disabled = true;
      break;
  }
}

// ── Heap animations ───────────────────────────────────────────
function pushHeapNode(value, src){
  const node = document.createElement('div');
  node.className = 'heap-node';
  node.dataset.val = value;
  node.dataset.src = src;
  node.textContent = `${Number(value).toFixed(1)} (s${src})`;
  heapNodesEl.appendChild(node);
  requestAnimationFrame(() => node.classList.add('visible'));
  // keep heap small in DOM
  while(heapNodesEl.children.length > 24) heapNodesEl.removeChild(heapNodesEl.children[0]);
}

function popHeapNode(value, src){
  const nodes = Array.from(heapNodesEl.children);
  const found = nodes.find(n => n.dataset.val == value && n.dataset.src == String(src));
  const target = found || nodes[0];
  if(!target) return;
  target.classList.add('popping');
  setTimeout(() => { if(target.parentNode) target.parentNode.removeChild(target); }, 220);
}

function emitOutput(value){
  const el = document.createElement('div');
  el.className = 'out-node';
  el.textContent = Number(value).toFixed(1);
  outputNodesEl.appendChild(el);
  requestAnimationFrame(() => el.classList.add('visible'));
  while(outputNodesEl.children.length > 48) outputNodesEl.removeChild(outputNodesEl.children[0]);
}

// ── Playback loop ─────────────────────────────────────────────
function tick(){
  if(paused || idx >= steps.length) return;
  processEvent(steps[idx++]);
  updateProgress();
  const delay = Math.max(40, 420 / speed);
  setTimeout(tick, delay);
}

// ── Controls ──────────────────────────────────────────────────
startBtn.onclick = () => {
  paused = false;
  startBtn.disabled = true;
  pauseBtn.disabled = false;
  pauseBtn.textContent = '⏸ Pause';
  tick();
};

pauseBtn.onclick = () => {
  paused = !paused;
  pauseBtn.textContent = paused ? '▶ Resume' : '⏸ Pause';
  if(!paused) tick();
};

stepBtn.onclick = () => {
  if(!paused){ paused = true; pauseBtn.textContent = '▶ Resume'; }
  if(idx < steps.length){
    processEvent(steps[idx++]);
    updateProgress();
  }
};

speedInput.oninput = () => {
  speed = parseFloat(speedInput.value);
  speedLabel.textContent = speed + '×';
};

// keyboard
document.addEventListener('keydown', e => {
  if(e.target.tagName === 'INPUT') return;
  if(e.code === 'Space'){
    e.preventDefault();
    if(startBtn.disabled === false && !pauseBtn.disabled === false){
      startBtn.click(); // first time
    } else {
      pauseBtn.click();
    }
  }
  if(e.key === 'ArrowRight') stepBtn.click();
});
</script>
</body>
</html>