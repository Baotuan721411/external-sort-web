<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>External Merge Sort â€” Visualizer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080c14;--surface:#0d1422;--card:#111926;
  --border:rgba(255,255,255,0.06);--text:#dde6f0;--muted:#5a7090;
  --cyan:#00d4ff;--violet:#8b5cf6;--green:#22d3a0;
  --orange:#f59e0b;--red:#f43f5e;--yellow:#fde047;
  --disk-bg:#06111f;--disk-border:#1e4080;
  --ram-bg:#0e0620;--ram-border:#5b21b6;
  --font-mono:'Space Mono',monospace;--font-body:'DM Sans',sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-body)}
body::before{content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:.4}

.app{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column;padding:20px;gap:14px;max-width:1500px;margin:0 auto}

/* â”€â”€ Header â”€â”€ */
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;align-items:baseline;gap:10px}
.brand-title{font-family:var(--font-mono);font-size:17px;font-weight:700;color:#fff}
.brand-tag{font-family:var(--font-mono);font-size:10px;color:var(--cyan);border:1px solid var(--cyan);padding:2px 7px;border-radius:4px;opacity:.7}
.upload-zone{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
#fileInput{display:none}
.file-label{display:flex;align-items:center;gap:7px;padding:7px 13px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:13px;color:var(--muted);transition:border-color .2s,color .2s}
.file-label:hover{border-color:var(--cyan);color:var(--text)}
#fileNameDisplay{font-size:12px;color:var(--muted);max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;border:none;font-family:var(--font-body);font-size:12px;font-weight:500;cursor:pointer;transition:opacity .15s,transform .1s}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--cyan),var(--violet));color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{color:var(--text);border-color:rgba(255,255,255,.15)}
.btn-back{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:var(--orange)}
.btn-back:hover{background:rgba(245,158,11,.18)}
.btn:disabled{opacity:.3;cursor:not-allowed;pointer-events:none}
.btn-dl{background:rgba(34,211,160,.12);border:1px solid rgba(34,211,160,.3);color:var(--green)}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .7s linear infinite;display:none}
.spinner.active{display:block}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Start Button â€” Ready State Glow â”€â”€ */
.btn-start-ready{
  background:linear-gradient(135deg,rgba(0,212,255,.15),rgba(139,92,246,.15));
  border:1px solid rgba(0,212,255,.55) !important;
  color:var(--cyan) !important;
  font-weight:600;
  animation:start-pulse 2s ease-in-out infinite;
}
@keyframes start-pulse{
  0%,100%{box-shadow:0 0 0 0 rgba(0,212,255,.0), 0 0 8px rgba(0,212,255,.3)}
  50%    {box-shadow:0 0 0 5px rgba(0,212,255,.12), 0 0 18px rgba(0,212,255,.5)}
}

/* â”€â”€ Guide Arrow â”€â”€ */
.guide-arrow-wrap{
  display:none;align-items:center;gap:6px;
  margin-bottom:8px;
}
.guide-arrow-wrap.show{display:flex}
.guide-arrow-txt{
  font-family:var(--font-mono);font-size:10px;color:var(--cyan);
  animation:guide-blink 1.2s ease-in-out infinite;
  white-space:nowrap;
}
.guide-arrow-svg{
  animation:guide-float 1s ease-in-out infinite;
  flex-shrink:0;
}
@keyframes guide-blink{
  0%,100%{opacity:1}50%{opacity:.35}
}
@keyframes guide-float{
  0%,100%{transform:translateX(0)}
  50%    {transform:translateX(5px)}
}

/* â”€â”€ Sampling Mode Banner â”€â”€ */
.sampling-banner{
  display:none;align-items:center;gap:12px;flex-wrap:wrap;
  padding:10px 16px;border-radius:10px;
  background:rgba(253,224,71,.06);border:1px solid rgba(253,224,71,.25);
}
.sampling-banner.show{display:flex}
.sb-icon{font-size:16px}
.sb-title{font-family:var(--font-mono);font-size:11px;font-weight:700;color:var(--yellow)}
.sb-desc{font-size:12px;color:var(--muted)}
.sb-pills{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
.sb-pill{font-family:var(--font-mono);font-size:10px;padding:3px 9px;border-radius:12px}
.sb-pill.real{background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.25);color:var(--cyan)}
.sb-pill.sim{background:rgba(253,224,71,.1);border:1px solid rgba(253,224,71,.25);color:var(--yellow)}

/* â”€â”€ Info bar â”€â”€ */
.info-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.info-pill{font-family:var(--font-mono);font-size:11px;padding:4px 10px;border-radius:20px;background:var(--card);border:1px solid var(--border);color:var(--muted)}
.info-pill span{color:var(--text);font-weight:700}
.info-pill.cyan span{color:var(--cyan)}
.info-pill.violet span{color:var(--violet)}
.info-pill.green span{color:var(--green)}
.phase-badge{font-family:var(--font-mono);font-size:11px;padding:4px 12px;border-radius:20px;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);color:var(--cyan);margin-left:auto}

/* â”€â”€ Progress â”€â”€ */
.progress-bar-wrap{display:flex;align-items:center;gap:10px}
.progress-track{flex:1;height:5px;background:rgba(255,255,255,.05);border-radius:5px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--violet));border-radius:5px;width:0%;transition:width .2s}
.progress-text{font-family:var(--font-mono);font-size:11px;color:var(--muted);white-space:nowrap}

/* â”€â”€ Main grid â”€â”€ */
.main{display:grid;grid-template-columns:1fr 300px;gap:14px;flex:1;align-items:start}
.stage{display:flex;flex-direction:column;gap:12px}

/* â”€â”€ Zones â”€â”€ */
.zone{border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px;transition:box-shadow .4s}
.zone-disk{background:var(--disk-bg);border:1px dashed var(--disk-border)}
.zone-ram{background:var(--ram-bg);border:1px solid var(--ram-border)}
.zone-disk.pulse{box-shadow:0 0 0 2px rgba(30,64,128,.5),0 0 20px rgba(30,64,128,.2)}
.zone-ram.pulse{box-shadow:0 0 0 2px rgba(91,33,182,.5),0 0 20px rgba(91,33,182,.2)}
.zone-header{display:flex;align-items:center;gap:8px}
.zone-icon{font-size:14px}
.zone-title{font-family:var(--font-mono);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.12em}
.zone-disk .zone-title{color:#4a7abf}
.zone-ram  .zone-title{color:#9b6fd4}
.zone-desc{font-size:11px;color:var(--muted);margin-left:auto}
.section-label{font-family:var(--font-mono);font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;padding:3px 0;border-bottom:1px solid var(--border)}

/* â”€â”€ Transfer arrow â”€â”€ */
.transfer-arrow{display:flex;align-items:center;gap:8px;padding:2px 0}
.ta-line{flex:1;height:1px;background:linear-gradient(90deg,var(--disk-border),var(--ram-border))}
.ta-label{font-family:var(--font-mono);font-size:10px;color:var(--muted);white-space:nowrap;padding:3px 10px;border-radius:10px;background:var(--card);border:1px solid var(--border);transition:color .2s,border-color .2s,background .2s}
.ta-label.active{color:var(--yellow);border-color:rgba(253,224,71,.4);background:rgba(253,224,71,.05);animation:ta-pulse 1.2s ease-in-out 3}
@keyframes ta-pulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(253,224,71,.3)}}

/* â”€â”€ Run cards â”€â”€ */
.runs-row{display:flex;gap:10px;flex-wrap:wrap}
.run-card{background:#0a1825;border:1px solid rgba(30,64,128,.35);border-radius:10px;padding:10px 12px;min-width:148px;max-width:210px;transition:border-color .25s,background .25s,opacity .3s}
.run-card.rc-reading{border-color:var(--yellow);background:rgba(253,224,71,.04)}
.run-card.rc-sorted {border-color:rgba(34,211,160,.45);background:rgba(34,211,160,.02)}
.run-card.rc-done   {opacity:.35}
.rc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}
.rc-title{font-family:var(--font-mono);font-size:10px;color:var(--muted)}
.rc-badge{font-size:9px;font-family:var(--font-mono);padding:1px 6px;border-radius:8px}
.rcb-unsorted{background:rgba(245,158,11,.15);color:var(--orange);border:1px solid rgba(245,158,11,.2)}
.rcb-sorted  {background:rgba(34,211,160,.15);color:var(--green);border:1px solid rgba(34,211,160,.2)}
.rcb-reading {background:rgba(253,224,71,.15);color:var(--yellow);border:1px solid rgba(253,224,71,.2)}
.rcb-done    {background:rgba(90,112,144,.1);color:var(--muted);border:1px solid rgba(90,112,144,.2)}
.rc-nums{font-family:var(--font-mono);font-size:10px;line-height:1.65;min-height:16px;color:#3d7a96;word-break:break-all}
.rc-nums .n-hi  {color:var(--yellow);font-weight:700}
.rc-nums .n-sort{color:var(--green)}
.rc-nums .n-dim {opacity:.35}
.rc-prog{height:2px;background:rgba(255,255,255,.04);border-radius:2px;margin-top:5px;overflow:hidden}
.rc-prog-fill{height:100%;background:linear-gradient(90deg,var(--yellow),var(--orange));border-radius:2px;width:0%;transition:width .35s}

/* â”€â”€ Buffer cards â”€â”€ */
.buffer-card{background:#0d061e;border:1px solid rgba(91,33,182,.35);border-radius:10px;padding:10px 12px;min-width:148px;max-width:210px;transition:border-color .25s,background .25s}
.buffer-card.bc-active  {border-color:rgba(139,92,246,.7);background:rgba(139,92,246,.04)}
.buffer-card.bc-refill  {border-color:var(--yellow);background:rgba(253,224,71,.03);animation:refill-pulse .8s ease-in-out 3}
.buffer-card.bc-empty   {opacity:.45}
@keyframes refill-pulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 10px rgba(253,224,71,.25)}}
.bc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}
.bc-title{font-family:var(--font-mono);font-size:10px;color:#9070cc}
.bc-from {font-size:9px;color:var(--muted);font-family:var(--font-mono)}
.bc-nums {font-family:var(--font-mono);font-size:10px;line-height:1.65;min-height:16px;word-break:break-all}
/* each number in buffer is a span with a data-pos attribute */
.bc-nums .bn{color:#9d7eed;transition:opacity .25s,color .25s}
.bc-nums .bn.bn-top {color:var(--violet);font-weight:700;font-size:11px}
.bc-nums .bn.bn-used{opacity:.2;color:var(--muted)}
.bc-refill-msg{font-size:9px;color:var(--yellow);font-family:var(--font-mono);margin-top:4px;display:none}
.bc-refill-msg.show{display:block;animation:blink .55s steps(1) infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ Heap SVG Binary Tree â”€â”€ */
.heap-wrap{background:rgba(0,0,0,.3);border:1px solid rgba(91,33,182,.25);border-radius:12px;padding:14px}
.heap-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.heap-hdr-title{font-family:var(--font-mono);font-size:10px;color:#9070cc;text-transform:uppercase;letter-spacing:.1em}
.heap-count{font-size:9px;color:var(--muted);font-family:var(--font-mono)}
.heap-svg-container{width:100%;overflow:visible}
.heap-svg-container svg{display:block;overflow:visible}
/* SVG node circle */
.hn-circle{fill:#1a0f2e;stroke:rgba(139,92,246,.55);stroke-width:1.6;
  transition:fill .3s,stroke .3s,stroke-width .3s,filter .3s}
.hn-circle.hnc-min{fill:#2d0820;stroke:#f43f5e;stroke-width:2.2;
  filter:drop-shadow(0 0 7px rgba(244,63,94,.65))}
.hn-circle.hnc-swap{fill:#231520;stroke:#fde047;stroke-width:2.2;
  filter:drop-shadow(0 0 7px rgba(253,224,71,.55))}
.hn-circle.hnc-compare{fill:#1a1a0c;stroke:#f59e0b;stroke-width:1.8;
  filter:drop-shadow(0 0 5px rgba(245,158,11,.45))}
.hn-circle.hnc-new{fill:#0c1a2e;stroke:#00d4ff;stroke-width:1.8;
  filter:drop-shadow(0 0 6px rgba(0,212,255,.45))}
/* SVG text */
.hn-val{font-family:'Space Mono',monospace;font-size:10.5px;fill:#c4b5fd;
  text-anchor:middle;dominant-baseline:middle;pointer-events:none;font-weight:400}
.hn-val.hnv-min{fill:#fff;font-weight:700}
.hn-val.hnv-swap{fill:#fde047;font-weight:700}
.hn-src{font-family:'Space Mono',monospace;font-size:8.5px;fill:rgba(155,130,210,.6);
  text-anchor:middle;dominant-baseline:middle;pointer-events:none}
.hn-src.hns-min{fill:rgba(255,140,140,.8)}
/* SVG edges */
.hn-edge{stroke:rgba(90,110,190,.3);stroke-width:1.2;fill:none;transition:stroke .3s}
.hn-edge.hne-swap{stroke:rgba(253,224,71,.7);stroke-width:1.8}
/* legend */
.heap-legend{font-size:9px;font-family:var(--font-mono);color:var(--muted);margin-top:8px;
  display:flex;gap:14px;flex-wrap:wrap}
.hl-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:3px;vertical-align:middle}

/* â”€â”€ Output â”€â”€ */
.output-wrap{background:var(--disk-bg);border:1px dashed rgba(34,211,160,.28);border-radius:10px;padding:12px}
.out-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.out-title{font-family:var(--font-mono);font-size:10px;color:var(--green);text-transform:uppercase;letter-spacing:.1em}
.out-count{font-size:9px;font-family:var(--font-mono);color:var(--muted)}
.out-stream{font-family:var(--font-mono);font-size:10px;line-height:1.8;min-height:24px;max-height:56px;overflow:hidden;word-break:break-all}
.out-num{color:rgba(34,211,160,.6);transition:color .4s}
.out-num.on-new{color:var(--green);font-weight:700}

/* â”€â”€ Flying token â”€â”€ */
.fly-token{
  position:fixed;z-index:9999;pointer-events:none;
  font-family:var(--font-mono);font-size:11px;font-weight:700;
  padding:4px 9px;border-radius:6px;
  background:var(--yellow);color:#000;
  box-shadow:0 0 14px rgba(253,224,71,.7);
}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{display:flex;flex-direction:column;gap:12px;position:sticky;top:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px}
.card-title{font-family:var(--font-mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px}

/* File info */
.fi-block{display:flex;flex-direction:column;gap:5px}
.fi-row{display:flex;justify-content:space-between;font-size:12px}
.fi-l{color:var(--muted)}
.fi-v{font-family:var(--font-mono);font-size:11px;color:var(--text)}
.fi-v.ac{color:var(--cyan)}

/* Stats */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-box{background:var(--card);border-radius:8px;padding:9px 11px}
.stat-label{font-size:10px;color:var(--muted);margin-bottom:3px}
.stat-val{font-family:var(--font-mono);font-size:16px;font-weight:700}
.stat-val.cyan{color:var(--cyan)}
.stat-val.violet{color:var(--violet)}
.stat-val.green{color:var(--green)}
.stat-hint{font-size:9px;color:var(--muted);margin-top:2px}

/* Controls */
.ctrl-row{display:flex;gap:6px;flex-wrap:wrap}
.speed-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.speed-row label{font-size:11px;color:var(--muted);font-family:var(--font-mono);white-space:nowrap}
input[type=range]{flex:1;-webkit-appearance:none;height:4px;background:rgba(255,255,255,.08);border-radius:4px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--cyan);cursor:pointer}
.hints{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.hint{font-size:10px;color:var(--muted)}
.hint kbd{font-family:var(--font-mono);background:var(--card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:9px}

/* History indicator */
.history-badge{font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-top:6px}
.history-badge span{color:var(--orange)}

/* Log */
.log-list{font-family:var(--font-mono);font-size:10px;color:var(--muted);display:flex;flex-direction:column;gap:3px;max-height:220px;overflow-y:auto}
.log-list::-webkit-scrollbar{width:3px}
.log-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.log-row{display:flex;gap:6px;line-height:1.5}
.log-t{opacity:.35;flex-shrink:0}
.log-row.info .log-m{color:var(--cyan)}
.log-row.ok   .log-m{color:var(--green)}
.log-row.warn .log-m{color:var(--orange)}
.log-row.disk .log-m{color:#3d7a96}
.log-row.ram  .log-m{color:#9070cc}
.log-row.back .log-m{color:var(--orange)}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:60px 20px;opacity:.3}
.empty-state p{font-size:13px;color:var(--muted);font-family:var(--font-mono)}

@media(max-width:900px){.main{grid-template-columns:1fr}.sidebar{position:static}}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<header>
  <div class="brand">
    <span class="brand-title">ext_merge_sort</span>
    <span class="brand-tag">VISUALIZER</span>
  </div>
  <div class="upload-zone">
    <input type="file" id="fileInput" accept=".bin"/>
    <label class="file-label" for="fileInput">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Chá»n file .bin
    </label>
    <span id="fileNameDisplay">ChÆ°a chá»n file</span>
    <div class="spinner" id="spinner"></div>
    <button class="btn btn-primary" id="uploadBtn" disabled>Visualize</button>
    <button class="btn btn-dl" id="downloadBtn" style="display:none">â†“ Download sorted</button>
  </div>
</header>

<!-- SAMPLING MODE BANNER -->
<div class="sampling-banner" id="samplingBanner">
  <span class="sb-icon">ğŸ”¬</span>
  <div>
    <div class="sb-title">Cháº¿ Ä‘á»™ mÃ´ phá»ng máº«u (Sampling Mode)</div>
    <div class="sb-desc">Visualization cháº¡y trÃªn <strong id="sbSimN">300</strong> sá»‘ máº«u â€” thuáº­t toÃ¡n tháº­t Ä‘ang sort toÃ n bá»™ file á»Ÿ background</div>
  </div>
  <div class="sb-pills">
    <span class="sb-pill real">File gá»‘c: <span id="sbRealN">â€”</span> sá»‘</span>
    <span class="sb-pill sim">MÃ´ phá»ng: N=<span id="sbSimNPill">â€”</span></span>
  </div>
</div>

<!-- INFO BAR -->
<div class="info-bar" id="infoBar" style="display:none">
  <div class="info-pill cyan">k-way <span id="statK">â€”</span></div>
  <div class="info-pill violet">block_size <span id="statB">â€”</span></div>
  <div class="info-pill">Runs <span id="statRuns">â€”</span></div>
  <div class="info-pill">Sample <span id="statSample">â€”</span> sá»‘</div>
  <div class="info-pill green">File <span id="statFile">â€”</span></div>
  <div class="phase-badge" id="phaseBadge">Chá» upload...</div>
</div>

<!-- PROGRESS -->
<div class="progress-bar-wrap" id="progressWrap" style="display:none">
  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
  <span class="progress-text" id="progressText">0 / 0</span>
</div>

<!-- MAIN -->
<div class="main">

  <div class="stage" id="stage">
    <div class="empty-state" id="emptyState">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
      </svg>
      <p>Upload file .bin Ä‘á»ƒ báº¯t Ä‘áº§u</p>
    </div>
    <div id="stageContent" style="display:none;flex-direction:column;gap:12px"></div>
  </div>

  <div class="sidebar">

    <div class="card" id="fileCard" style="display:none">
      <div class="card-title">ğŸ“ ThÃ´ng tin File</div>
      <div class="fi-block">
        <div class="fi-row"><span class="fi-l">TÃªn file</span><span class="fi-v ac" id="fiName">â€”</span></div>
        <div class="fi-row"><span class="fi-l">KÃ­ch thÆ°á»›c</span><span class="fi-v" id="fiSize">â€”</span></div>
        <div class="fi-row"><span class="fi-l">Tá»•ng pháº§n tá»­</span><span class="fi-v" id="fiCount">â€”</span></div>
        <div class="fi-row"><span class="fi-l">MÃ´ phá»ng</span><span class="fi-v" style="color:var(--yellow)" id="fiSim">â€”</span></div>
      </div>
    </div>

    <div class="card" id="paramsCard" style="display:none">
      <div class="card-title">âš™ï¸ Tham sá»‘ thuáº­t toÃ¡n</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">k-way merge</div>
          <div class="stat-val cyan" id="sk">â€”</div>
          <div class="stat-hint">merge k runs/lÃºc</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">block_size</div>
          <div class="stat-val violet" id="sb">â€”</div>
          <div class="stat-hint">sá»‘/láº§n Ä‘á»c disk</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Sá»‘ runs</div>
          <div class="stat-val green" id="sr">â€”</div>
          <div class="stat-hint">runs ban Ä‘áº§u</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">RAM dÃ¹ng</div>
          <div class="stat-val" id="sram" style="font-size:12px">â€”</div>
          <div class="stat-hint">kÃ—block + heap</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ® Äiá»u khiá»ƒn</div>
      <div class="guide-arrow-wrap" id="guideArrow">
        <svg class="guide-arrow-svg" width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M5 12h14M13 6l6 6-6 6" stroke="#00d4ff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="guide-arrow-txt">Nháº¥n Start Ä‘á»ƒ báº¯t Ä‘áº§u mÃ´ phá»ng</span>
      </div>
      <div class="ctrl-row">
        <button class="btn btn-ghost" id="startBtn" disabled>â–¶ Start</button>
        <button class="btn btn-ghost" id="pauseBtn" disabled>â¸ Pause</button>
        <button class="btn btn-ghost" id="stepBtn"  disabled>â­ Step</button>
        <button class="btn btn-back"  id="backBtn"  disabled>â† Back</button>
      </div>
      <div class="speed-row">
        <label>Speed</label>
        <input type="range" id="speedInput" min="0.25" max="4" step="0.25" value="0.25"/>
        <span style="font-family:var(--font-mono);font-size:11px;color:var(--cyan);min-width:28px" id="speedLabel">0.25Ã—</span>
      </div>
      <div class="hints">
        <span class="hint"><kbd>Space</kbd> pause</span>
        <span class="hint"><kbd>â†’</kbd> step</span>
        <span class="hint"><kbd>â†</kbd> back</span>
      </div>
      <div class="history-badge" id="historyBadge" style="display:none">
        Lá»‹ch sá»­: <span id="historyCount">0</span> bÆ°á»›c Ä‘Ã£ lÆ°u
      </div>
    </div>

    <div class="card" style="flex:1">
      <div class="card-title">ğŸ“‹ Event Log</div>
      <div class="log-list" id="logList"></div>
    </div>

  </div>
</div>
</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fileInput      = document.getElementById('fileInput');
const fileNameDisp   = document.getElementById('fileNameDisplay');
const uploadBtn      = document.getElementById('uploadBtn');
const downloadBtn    = document.getElementById('downloadBtn');
const spinner        = document.getElementById('spinner');
const samplingBanner = document.getElementById('samplingBanner');
const sbSimN         = document.getElementById('sbSimN');
const sbRealN        = document.getElementById('sbRealN');
const sbSimNPill     = document.getElementById('sbSimNPill');
const infoBar        = document.getElementById('infoBar');
const progressWrap   = document.getElementById('progressWrap');
const progressFill   = document.getElementById('progressFill');
const progressText   = document.getElementById('progressText');
const phaseBadge     = document.getElementById('phaseBadge');
const emptyState     = document.getElementById('emptyState');
const stageContent   = document.getElementById('stageContent');
const fileCard       = document.getElementById('fileCard');
const paramsCard     = document.getElementById('paramsCard');
const startBtn       = document.getElementById('startBtn');
const pauseBtn       = document.getElementById('pauseBtn');
const stepBtn        = document.getElementById('stepBtn');
const backBtn        = document.getElementById('backBtn');
const speedInput     = document.getElementById('speedInput');
const speedLabel     = document.getElementById('speedLabel');
const logList        = document.getElementById('logList');
const historyBadge   = document.getElementById('historyBadge');
const historyCount   = document.getElementById('historyCount');
const guideArrow     = document.getElementById('guideArrow');

const statK    = document.getElementById('statK');
const statB    = document.getElementById('statB');
const statRuns = document.getElementById('statRuns');
const statSample = document.getElementById('statSample');
const statFile = document.getElementById('statFile');
const sk = document.getElementById('sk');
const sb = document.getElementById('sb');
const sr = document.getElementById('sr');
const sram = document.getElementById('sram');
const fiName  = document.getElementById('fiName');
const fiSize  = document.getElementById('fiSize');
const fiCount = document.getElementById('fiCount');
const fiSim   = document.getElementById('fiSim');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let steps = [], idx = 0, paused = true, speed = 0.5, totalSteps = 0, jobId = null;
let currentPassId = null, currentGroupId = null;
let animating = false;  // block rapid clicks during fly animation

// â”€â”€ History Stack â”€â”€
// Each entry = full snapshot of the visual state at that step
const history = [];       // pastStates
const MAX_HISTORY = 200;  // cap to avoid huge memory

// â”€â”€ Live visual state (mirrored for snapshot) â”€â”€
// These objects are what we snapshot
let VS = createEmptyVS();

function createEmptyVS(){
  return {
    idx: 0,
    phaseBadgeText: 'Chá» upload...',
    // run cards: runIdx â†’ {nums, state, count}
    runs: {},
    // buffer cards: `${passId}-${groupId}-${bufIdx}` â†’ {nums, usedCount}
    bufs: {},
    // heap: array of {value, src}
    heap: [],
    // output: array of numbers (last 60)
    output: [],
    outputCount: 0,
    // log entries: array of {msg, type}
    logEntries: [],
    // current merge context
    passId: null,
    groupId: null,
    // dom structure flags
    mergeZones: [],  // [{passId, groupId, inputs}]
    transferMsg: '',
  };
}

function snapshotVS(){
  // Deep clone of VS
  return JSON.parse(JSON.stringify(VS));
}

function pushHistory(){
  history.push(snapshotVS());
  if(history.length > MAX_HISTORY) history.shift();
  updateHistoryBadge();
}

function updateHistoryBadge(){
  historyBadge.style.display = history.length ? 'block' : 'none';
  historyCount.textContent = history.length;
  backBtn.disabled = history.length === 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function log(msg, type='', skipVS=false){
  const row = document.createElement('div');
  row.className = 'log-row' + (type ? ' '+type : '');
  const t = new Date().toLocaleTimeString('vi',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  row.innerHTML = `<span class="log-t">${t}</span><span class="log-m">${msg}</span>`;
  logList.prepend(row);
  while(logList.children.length > 120) logList.removeChild(logList.lastChild);
  if(!skipVS){
    VS.logEntries.unshift({msg, type, t});
    if(VS.logEntries.length > 120) VS.logEntries.pop();
  }
}

function rebuildLogFromVS(entries){
  logList.innerHTML = '';
  entries.forEach(e => {
    const row = document.createElement('div');
    row.className = 'log-row' + (e.type ? ' '+e.type : '');
    row.innerHTML = `<span class="log-t">${e.t}</span><span class="log-m">${e.msg}</span>`;
    logList.appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateProgress(){
  const pct = totalSteps ? Math.round(VS.idx/totalSteps*100) : 0;
  progressFill.style.width = pct + '%';
  progressText.textContent = `${VS.idx} / ${totalSteps}`;
  phaseBadge.textContent = VS.phaseBadgeText;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(v){ return Number(v).toFixed(1); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE PICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fileInput.onchange = () => {
  const f = fileInput.files[0];
  if(!f) return;
  fileNameDisp.textContent = f.name;
  uploadBtn.disabled = false;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
uploadBtn.onclick = async () => {
  const f = fileInput.files[0];
  if(!f){ alert('Chá»n file .bin trÆ°á»›c'); return; }
  uploadBtn.disabled = true;
  spinner.classList.add('active');
  downloadBtn.style.display = 'none';
  phaseBadge.textContent = 'Äang upload...';
  log('Äang upload & xá»­ lÃ½...', 'info');

  const fd = new FormData();
  fd.append('file', f);
  let vizData;
  try{
    const r = await fetch('/sort/visualize', {method:'POST', body:fd});
    if(!r.ok){
      const err = await r.json().catch(()=>({detail:r.statusText}));
      throw new Error(err.detail || r.statusText);
    }
    vizData = await r.json();
  } catch(e){
    log('Lá»—i: '+e.message, 'warn');
    spinner.classList.remove('active');
    uploadBtn.disabled = false;
    phaseBadge.textContent = 'Lá»—i';
    return;
  }

  if(vizData.job_id){ jobId = vizData.job_id; pollForDownload(jobId); }

  steps      = vizData.steps || [];
  totalSteps = steps.length;
  idx        = 0;
  history.length = 0;
  VS         = createEmptyVS();
  resetStage();

  const meta   = vizData.meta || steps.find(s=>s.type==='meta');
  const params = steps.find(s=>s.type==='params_chosen');

  const simN  = params?.visualize_sample_size ?? meta?.runs_count ?? 300;
  const realN = params?.original_file_size ? Math.floor(params.original_file_size/8) : null;

  // Sampling banner
  sbSimN.textContent    = simN;
  sbSimNPill.textContent= simN;
  sbRealN.textContent   = realN ? realN.toLocaleString() : 'â€”';
  samplingBanner.classList.add('show');

  if(meta){
    statK.textContent    = meta.k    ?? 'â€”';
    statB.textContent    = meta.block_size ?? 'â€”';
    statRuns.textContent = meta.runs_count ?? 'â€”';
    sk.textContent = meta.k ?? 'â€”';
    sb.textContent = meta.block_size ?? 'â€”';
    sr.textContent = meta.runs_count ?? 'â€”';
  }
  if(params){
    statSample.textContent = simN;
    const k  = meta?.k ?? params.k ?? 4;
    const bs = meta?.block_size ?? params.block_size ?? 0;
    sram.textContent = `â‰¤ ${k*bs+k} sá»‘`;
    if(params.original_file_size){
      const mb = (params.original_file_size/1024/1024).toFixed(2);
      statFile.textContent = mb+' MB';
      fiSize.textContent   = mb+' MB';
      fiCount.textContent  = Math.floor(params.original_file_size/8).toLocaleString()+' sá»‘';
    }
  }
  fiName.textContent = f.name;
  fiSim.textContent  = `${simN} sá»‘ máº«u`;
  infoBar.style.display      = 'flex';
  progressWrap.style.display = 'flex';
  fileCard.style.display     = 'block';
  paramsCard.style.display   = 'block';

  spinner.classList.remove('active');
  VS.phaseBadgeText = 'Sáºµn sÃ ng';
  updateProgress();
  log(`Nháº­n ${steps.length} steps â€” nháº¥n Start Ä‘á»ƒ xem`, 'ok');
  startBtn.disabled = false;
  startBtn.classList.add('btn-start-ready');
  stepBtn.disabled  = false;
  guideArrow.classList.add('show');
  updateHistoryBadge();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POLL DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pollForDownload(jid){
  const setBtn = (label, ready) => {
    downloadBtn.textContent  = label;
    downloadBtn.style.display  = 'inline-flex';
    downloadBtn.style.opacity  = ready ? '1' : '0.5';
    downloadBtn.style.cursor   = ready ? 'pointer' : 'default';
    downloadBtn.onclick = ready ? ()=>window.location=`/download/${jid}` : null;
  };
  setBtn('â³ Äang sort...', false);
  const poll = async () => {
    try{
      const r = await fetch(`/status/${jid}`);
      if(!r.ok){ setTimeout(poll,2000); return; }
      const d = await r.json();
      if(d.status==='done'){ setBtn('â†“ Download sorted',true); log('âœ“ Sort tháº­t xong â€” sáºµn sÃ ng download','ok'); }
      else if(d.status?.startsWith('error')){ downloadBtn.style.display='none'; log('Sort lá»—i: '+d.status,'warn'); }
      else{ setBtn(d.status==='processing'?'â³ Sorting...':'â³ Queued...',false); setTimeout(poll,1500); }
    } catch(e){ setTimeout(poll,3000); }
  };
  poll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET STAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetStage(){
  stageContent.innerHTML = '';
  stageContent.style.display = 'flex';
  emptyState.style.display   = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD DOM â€” Phase 1 Disk Zone
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ensurePhase1(){
  if(document.getElementById('zone-ph1')) return;
  const z = document.createElement('div');
  z.className = 'zone zone-disk'; z.id = 'zone-ph1';
  z.innerHTML = `
    <div class="zone-header">
      <span class="zone-icon">ğŸ’¾</span>
      <span class="zone-title">Disk â€” Bá»™ nhá»› ngoÃ i</span>
      <span class="zone-desc">Dá»¯ liá»‡u quÃ¡ lá»›n, khÃ´ng thá»ƒ giá»¯ trong RAM</span>
    </div>
    <div class="section-label">Phase 1 â€” Táº¡o Initial Runs</div>
    <div class="runs-row" id="ph1-runs"></div>`;
  stageContent.appendChild(z);
}

function getOrCreateRunCard(runIdx){
  if(document.getElementById(`rc-${runIdx}`)) return document.getElementById(`rc-${runIdx}`);
  ensurePhase1();
  const row = document.getElementById('ph1-runs');
  const el  = document.createElement('div');
  el.className = 'run-card'; el.id = `rc-${runIdx}`;
  el.innerHTML = `
    <div class="rc-header">
      <span class="rc-title" id="rc-t-${runIdx}">ğŸ’¾ Run ${runIdx}</span>
      <span class="rc-badge rcb-unsorted" id="rc-b-${runIdx}">chÆ°a sort</span>
    </div>
    <div class="rc-nums" id="rc-n-${runIdx}">â€”</div>
    <div class="rc-prog"><div class="rc-prog-fill" id="rc-f-${runIdx}"></div></div>`;
  row.appendChild(el);
  if(!VS.runs[runIdx]) VS.runs[runIdx] = {nums:[], state:'unsorted', count:0};
  return el;
}

function renderRunCard(runIdx){
  const data = VS.runs[runIdx];
  if(!data) return;
  const el  = getOrCreateRunCard(runIdx);
  const numEl  = document.getElementById(`rc-n-${runIdx}`);
  const badEl  = document.getElementById(`rc-b-${runIdx}`);
  if(!numEl || !badEl) return;

  el.className = 'run-card' + (data.state==='reading'?' rc-reading':data.state==='sorted'?' rc-sorted':data.state==='done'?' rc-done':'');
  const badgeMap = {unsorted:['rcb-unsorted','chÆ°a sort'],reading:['rcb-reading','ğŸ“– Ä‘á»c vÃ o RAM'],sorted:['rcb-sorted','âœ“ Ä‘Ã£ sort'],done:['rcb-done','âœ“ xong']};
  const [cls,txt] = badgeMap[data.state] || badgeMap.unsorted;
  badEl.className = 'rc-badge ' + cls;
  badEl.textContent = txt;

  if(data.nums && data.nums.length){
    const shown = data.nums.slice(0, 7);
    numEl.innerHTML = shown.map((v,i)=>{
      const cls = i===0 && data.state==='reading' ? 'n-hi' : data.state==='sorted' ? 'n-sort' : '';
      return `<span class="${cls}">${fmt(v)}</span>`;
    }).join('  ') + (data.nums.length>7 ? `  <span class="n-dim">+${data.nums.length-7}...</span>` : '');
  } else {
    numEl.innerHTML = '<span class="n-dim">â€”</span>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSFER ARROW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let taLabelEl = null;
function ensureTransferArrow(){
  if(document.getElementById('ta')) return;
  const el = document.createElement('div');
  el.className = 'transfer-arrow'; el.id = 'ta';
  el.innerHTML = `
    <div class="ta-line"></div>
    <div class="ta-label" id="ta-label">ğŸ’¾ Disk â†’ ğŸ§  RAM</div>
    <div class="ta-line"></div>`;
  stageContent.appendChild(el);
  taLabelEl = document.getElementById('ta-label');
}
function flashTransfer(msg){
  ensureTransferArrow();
  if(!taLabelEl) return;
  taLabelEl.textContent = msg;
  taLabelEl.classList.remove('active');
  void taLabelEl.offsetWidth;
  taLabelEl.classList.add('active');
  VS.transferMsg = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD DOM â€” Merge Zone (RAM + Output)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentHeapEl = null;
let currentOutEl  = null;
let currentOutCountEl = null;

function ensureMergeZone(passId, groupId, inputs){
  const id = `mz-${passId}-${groupId}`;
  if(document.getElementById(id)){
    currentHeapEl    = document.getElementById(`${id}-heap`);
    currentOutEl     = document.getElementById(`${id}-out`);
    currentOutCountEl= document.getElementById(`${id}-out-cnt`);
    return;
  }
  ensureTransferArrow();

  // RAM zone
  const ramZone = document.createElement('div');
  ramZone.className = 'zone zone-ram'; ramZone.id = id;
  ramZone.innerHTML = `
    <div class="zone-header">
      <span class="zone-icon">ğŸ§ </span>
      <span class="zone-title">RAM â€” Bá»™ nhá»› trong</span>
      <span class="zone-desc">LÆ°á»£t trá»™n ${passId} Â· NhÃ³m ${groupId}</span>
    </div>
    <div class="section-label">Input Buffers (Ä‘á»c tá»«ng khá»‘i tá»« Disk)</div>
    <div class="runs-row" id="${id}-bufs"></div>
    <div class="section-label" style="margin-top:4px">Min-Heap â€” Binary Tree (so sÃ¡nh trong RAM)</div>
    <div class="heap-wrap">
      <div class="heap-hdr">
        <span class="heap-hdr-title">MIN-HEAP</span>
        <span class="heap-count" id="${id}-hcnt">0 pháº§n tá»­</span>
      </div>
      <div class="heap-svg-container" id="${id}-heap"></div>
      <div class="heap-legend">
        <span><span class="hl-dot" style="background:#f43f5e;box-shadow:0 0 4px rgba(244,63,94,.5)"></span>Root (nhá» nháº¥t)</span>
        <span><span class="hl-dot" style="background:rgba(139,92,246,.5)"></span>Node bÃ¬nh thÆ°á»ng</span>
        <span><span class="hl-dot" style="background:#fde047;box-shadow:0 0 4px rgba(253,224,71,.4)"></span>Äang swap</span>
      </div>
    </div>`;

  // Disk output zone
  const diskOut = document.createElement('div');
  diskOut.className = 'zone zone-disk';
  diskOut.innerHTML = `
    <div class="zone-header">
      <span class="zone-icon">ğŸ’¾</span>
      <span class="zone-title">Disk â€” Output</span>
      <span class="zone-desc">Ghi káº¿t quáº£ Ä‘Ã£ merge vá» Disk</span>
    </div>
    <div class="output-wrap">
      <div class="out-header">
        <span class="out-title">Luá»“ng output (Ä‘Ã£ sáº¯p xáº¿p)</span>
        <span class="out-count" id="${id}-out-cnt">0 pháº§n tá»­</span>
      </div>
      <div class="out-stream" id="${id}-out"></div>
    </div>`;

  stageContent.appendChild(ramZone);
  stageContent.appendChild(diskOut);
  stageContent.scrollTop = stageContent.scrollHeight;

  currentHeapEl     = document.getElementById(`${id}-heap`);
  currentOutEl      = document.getElementById(`${id}-out`);
  currentOutCountEl = document.getElementById(`${id}-out-cnt`);

  VS.mergeZones.push({passId, groupId, inputs: inputs||[]});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUFFER CARDS â€” Pop & Shift
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBufKey(passId, groupId, bufIdx){ return `${passId}-${groupId}-${bufIdx}`; }

function getOrCreateBufCard(passId, groupId, bufIdx){
  const cid  = `bc-${passId}-${groupId}-${bufIdx}`;
  if(document.getElementById(cid)) return document.getElementById(cid);
  const bufsRow = document.getElementById(`mz-${passId}-${groupId}-bufs`);
  if(!bufsRow) return null;
  const el = document.createElement('div');
  el.className = 'buffer-card'; el.id = cid;
  el.innerHTML = `
    <div class="bc-header">
      <span class="bc-title">ğŸ§  Buffer ${bufIdx}</span>
      <span class="bc-from">â† Run ${bufIdx}</span>
    </div>
    <div class="bc-nums" id="${cid}-nums">â€”</div>
    <div class="bc-refill-msg" id="${cid}-refill">â¬‡ Náº¡p thÃªm tá»« Disk...</div>`;
  bufsRow.appendChild(el);
  const key = getBufKey(passId, groupId, bufIdx);
  if(!VS.bufs[key]) VS.bufs[key] = {nums:[], usedCount:0};
  return el;
}

function renderBufCard(passId, groupId, bufIdx){
  const key  = getBufKey(passId, groupId, bufIdx);
  const data = VS.bufs[key];
  if(!data) return;
  const cid  = `bc-${passId}-${groupId}-${bufIdx}`;
  const el   = document.getElementById(cid) || getOrCreateBufCard(passId, groupId, bufIdx);
  if(!el) return;
  const numsEl   = document.getElementById(`${cid}-nums`);
  const refillEl = document.getElementById(`${cid}-refill`);
  if(!numsEl) return;

  const live = data.nums;
  const used = data.usedCount || 0;

  if(!live || !live.length){
    el.classList.add('bc-empty');
    el.classList.remove('bc-active');
    numsEl.innerHTML = '<span style="opacity:.35;color:var(--muted)">háº¿t dá»¯ liá»‡u</span>';
  } else {
    el.classList.remove('bc-empty');
    el.classList.add('bc-active');
    // Show all tracked numbers; mark first `used` as dimmed
    numsEl.innerHTML = live.map((v, i) => {
      const isDimmed = i < used;
      const isTop    = i === used; // first non-used = current top
      return `<span class="bn${isDimmed?' bn-used':isTop?' bn-top':''}" data-pos="${i}">${fmt(v)}</span>`;
    }).join('  ');
  }
  if(refillEl) refillEl.classList.toggle('show', data.refilling || false);
}

// Mark top of buffer as used (pop & shift visual)
function bufPopTop(passId, groupId, bufIdx){
  const key  = getBufKey(passId, groupId, bufIdx);
  if(!VS.bufs[key]) return;
  VS.bufs[key].usedCount = (VS.bufs[key].usedCount || 0) + 1;
  renderBufCard(passId, groupId, bufIdx);
}

function bufRefill(passId, groupId, bufIdx, newNums){
  const key = getBufKey(passId, groupId, bufIdx);
  VS.bufs[key] = {nums: newNums, usedCount: 0, refilling: false};
  const cid = `bc-${passId}-${groupId}-${bufIdx}`;
  const el  = document.getElementById(cid);
  if(el){ el.classList.add('bc-refill'); setTimeout(()=>el.classList.remove('bc-refill'), 1200); }
  renderBufCard(passId, groupId, bufIdx);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEAP â€” SVG Binary Tree Engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Layout constants
const H_R     = 22;    // node radius
const H_LH    = 68;    // level height (vertical gap centre-to-centre)
const H_W_MIN = 340;   // minimum SVG width
const H_MAX_NODES = 31; // show max 5 levels (2^5-1 = 31)

// Compute (cx, cy) for node at index i in a heap
// Uses full binary tree layout: assign column in leaf row
function heapNodePos(i, n, svgW){
  // depth of node i (0-indexed)
  const depth = Math.floor(Math.log2(i + 1));
  const maxDepth = Math.floor(Math.log2(Math.min(n, H_MAX_NODES)));
  // position within its level
  const levelStart = (1 << depth) - 1;   // 2^depth - 1
  const posInLevel = i - levelStart;
  const levelCount = Math.min((1 << depth), n - levelStart);
  // number of slots at max depth row
  const slots = 1 << maxDepth;
  // each node occupies slots/(levelCount) columns
  const stride = slots / (1 << depth);
  const col    = posInLevel * stride + stride / 2;
  const cx = (col / slots) * svgW;
  const cy = H_R + depth * H_LH;
  return {cx, cy, depth};
}

function heapSVGHeight(n){
  if(!n) return 60;
  const maxDepth = Math.floor(Math.log2(Math.min(n, H_MAX_NODES)));
  return H_R * 2 + maxDepth * H_LH + H_R + 10;
}

// Build a <g> element for a single node
function makeNodeG(i, node, isMin, svgW, n, extraClass=''){
  const {cx, cy} = heapNodePos(i, n, svgW);
  const ns = 'http://www.w3.org/2000/svg';
  const g  = document.createElementNS(ns, 'g');
  g.setAttribute('class', 'hn-g');
  g.dataset.idx = i;

  const circle = document.createElementNS(ns, 'circle');
  circle.setAttribute('cx', cx);
  circle.setAttribute('cy', cy);
  circle.setAttribute('r', H_R);
  circle.setAttribute('class', 'hn-circle' + (isMin ? ' hnc-min' : '') + (extraClass ? ' '+extraClass : ''));
  g.appendChild(circle);

  // value text (top line)
  const valTxt = document.createElementNS(ns, 'text');
  valTxt.setAttribute('x', cx);
  valTxt.setAttribute('y', cy - 5);
  valTxt.setAttribute('class', 'hn-val' + (isMin ? ' hnv-min' : ''));
  valTxt.textContent = fmt(node.value);
  g.appendChild(valTxt);

  // source label (bottom line)
  const srcTxt = document.createElementNS(ns, 'text');
  srcTxt.setAttribute('x', cx);
  srcTxt.setAttribute('y', cy + 9);
  srcTxt.setAttribute('class', 'hn-src' + (isMin ? ' hns-min' : ''));
  srcTxt.textContent = `s${node.src}`;
  g.appendChild(srcTxt);

  return g;
}

// Build edge line from parent i to child j
function makeEdge(i, j, n, svgW, extraClass=''){
  const ns = 'http://www.w3.org/2000/svg';
  const {cx:x1, cy:y1} = heapNodePos(i, n, svgW);
  const {cx:x2, cy:y2} = heapNodePos(j, n, svgW);
  const line = document.createElementNS(ns, 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y1 + H_R);
  line.setAttribute('x2', x2); line.setAttribute('y2', y2 - H_R);
  line.setAttribute('class', 'hn-edge' + (extraClass ? ' '+extraClass : ''));
  return line;
}

// Full redraw of the heap SVG
function rebuildHeapDOM(highlightIdx = -1, swapPair = null){
  if(!currentHeapEl) return;
  const heap = VS.heap;

  // update count badge
  const cntEl = currentHeapEl.closest('.heap-wrap')?.querySelector('.heap-count');
  if(cntEl) cntEl.textContent = heap.length + ' pháº§n tá»­';

  if(!heap.length){
    currentHeapEl.innerHTML = '<div style="opacity:.3;font-size:10px;font-family:var(--font-mono);color:#5a7090;padding:18px 0;text-align:center">heap trá»‘ng</div>';
    return;
  }

  const ns    = 'http://www.w3.org/2000/svg';
  const shown = Math.min(heap.length, H_MAX_NODES);
  const wrap  = currentHeapEl;
  const svgW  = Math.max(H_W_MIN, wrap.clientWidth || H_W_MIN);
  const svgH  = heapSVGHeight(shown);

  const svg = document.createElementNS(ns, 'svg');
  svg.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);
  svg.setAttribute('width', svgW);
  svg.setAttribute('height', svgH);

  // === Layer 1: edges (drawn first, behind nodes) ===
  const edgeG = document.createElementNS(ns, 'g');
  for(let i = 0; i < shown; i++){
    const left  = 2*i + 1;
    const right = 2*i + 2;
    if(left  < shown){
      const isSwapEdge = swapPair && ((i===swapPair[0]&&left===swapPair[1])||(i===swapPair[1]&&left===swapPair[0]));
      edgeG.appendChild(makeEdge(i, left,  shown, svgW, isSwapEdge ? 'hne-swap' : ''));
    }
    if(right < shown){
      const isSwapEdge = swapPair && ((i===swapPair[0]&&right===swapPair[1])||(i===swapPair[1]&&right===swapPair[0]));
      edgeG.appendChild(makeEdge(i, right, shown, svgW, isSwapEdge ? 'hne-swap' : ''));
    }
  }
  svg.appendChild(edgeG);

  // === Layer 2: nodes ===
  const nodeG = document.createElementNS(ns, 'g');
  const minVal = heap[0].value; // heap[0] is always root = min in a min-heap
  for(let i = 0; i < shown; i++){
    const isMin     = (i === 0);
    const isSwap    = swapPair && (i === swapPair[0] || i === swapPair[1]);
    const isCompare = (i === highlightIdx);
    let extraClass  = '';
    if(isSwap)    extraClass = 'hnc-swap';
    else if(isCompare) extraClass = 'hnc-compare';
    nodeG.appendChild(makeNodeG(i, heap[i], isMin, svgW, shown, extraClass));
  }
  svg.appendChild(nodeG);

  // overflow indicator
  if(heap.length > H_MAX_NODES){
    const txt = document.createElementNS(ns, 'text');
    txt.setAttribute('x', svgW / 2);
    txt.setAttribute('y', svgH - 4);
    txt.setAttribute('text-anchor', 'middle');
    txt.setAttribute('font-family', "'Space Mono',monospace");
    txt.setAttribute('font-size', '9');
    txt.setAttribute('fill', 'rgba(90,112,144,.6)');
    txt.textContent = `+${heap.length - H_MAX_NODES} node khÃ´ng hiá»ƒn thá»‹`;
    svg.appendChild(txt);
  }

  wrap.innerHTML = '';
  wrap.appendChild(svg);
}

// â”€â”€ Animated sift-down: returns Promise â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Visual-only: swaps positions in VS.heap then redraws step by step
async function animateSiftDown(startIdx, delayMs){
  let i = startIdx;
  const h = VS.heap;
  while(true){
    const left  = 2*i + 1;
    const right = 2*i + 2;
    let smallest = i;
    if(left  < h.length && h[left].value  < h[smallest].value) smallest = left;
    if(right < h.length && h[right].value < h[smallest].value) smallest = right;
    if(smallest === i) break;

    // Flash compare highlight on children
    rebuildHeapDOM(smallest, null);
    await sleep(delayMs * 0.55);

    // Swap in data
    [h[i], h[smallest]] = [h[smallest], h[i]];

    // Draw swap highlighted
    rebuildHeapDOM(-1, [i, smallest]);
    await sleep(delayMs * 0.7);

    i = smallest;
  }
  rebuildHeapDOM();
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ heapPush: add node to end, then sift-up visually â”€â”€â”€â”€â”€â”€â”€â”€â”€
function heapPush(value, src){
  VS.heap.push({value, src});
  // Highlight new node briefly
  rebuildHeapDOM(VS.heap.length - 1, null);
  setTimeout(() => rebuildHeapDOM(), 250);
}

// â”€â”€ heapPop: animate root flying out, sift down â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// popRoot animates the root node flying toward the output zone,
// then restructures the heap with sift-down animation.
// Returns a Promise so callers can await it.
function heapPop(value, src){
  // Remove the correct node from VS data
  const idx = VS.heap.findIndex(n => n.value == value && n.src == String(src));
  if(idx !== -1) VS.heap.splice(idx, 1);
  else if(VS.heap.length) VS.heap.shift();

  // If speed is fast (>1.5x) skip heavy animation, just redraw
  if(speed > 1.5){
    rebuildHeapDOM();
    return;
  }

  // Animate sift-down for the new root (if heap non-empty)
  const delayMs = Math.max(80, 320 / speed);
  if(VS.heap.length > 1){
    animateSiftDown(0, delayMs);
  } else {
    rebuildHeapDOM();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OUTPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emitOutput(value){
  VS.output.push(value);
  VS.outputCount++;
  if(VS.output.length > 60) VS.output.shift();
  renderOutput();
}

function renderOutput(){
  if(!currentOutEl) return;
  const latest = VS.output[VS.output.length-1];
  currentOutEl.innerHTML = VS.output.map((v,i)=>{
    const isNew = i === VS.output.length-1;
    return `<span class="out-num${isNew?' on-new':''}">${fmt(v)}</span>`;
  }).join('  ');
  if(currentOutCountEl) currentOutCountEl.textContent = VS.outputCount+' pháº§n tá»­';
  // fade new highlight
  const newEl = currentOutEl.querySelector('.on-new');
  if(newEl) setTimeout(()=>newEl.classList.remove('on-new'), 600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLYING TOKEN ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function flyToken(fromEl, toEl, value, color='var(--yellow)', onDone){
  if(!fromEl || !toEl){ onDone?.(); return; }
  const fr = fromEl.getBoundingClientRect();
  const tr = toEl.getBoundingClientRect();
  const token = document.createElement('div');
  token.className = 'fly-token';
  token.textContent = fmt(value);
  token.style.cssText = `left:${fr.left+fr.width/2}px;top:${fr.top+fr.height/2}px;background:${color}`;
  document.body.appendChild(token);

  const dx = (tr.left+tr.width/2)  - (fr.left+fr.width/2);
  const dy = (tr.top +tr.height/2) - (fr.top +fr.height/2);
  const dur= Math.min(480, Math.max(180, Math.sqrt(dx*dx+dy*dy)*0.45));

  token.animate([
    {transform:'translate(-50%,-50%) scale(1)',   opacity:1},
    {transform:`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(0.75)`, opacity:0}
  ],{duration:dur, easing:'ease-in'}).onfinish = ()=>{ token.remove(); onDone?.(); };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESTORE SNAPSHOT (Back button)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function restoreSnapshot(snap){
  VS = JSON.parse(JSON.stringify(snap));
  idx = VS.idx;

  // Rebuild DOM from VS
  stageContent.innerHTML = '';

  // Re-create phase1 zone if needed
  if(Object.keys(VS.runs).length > 0){
    ensurePhase1();
    Object.keys(VS.runs).forEach(ri => renderRunCard(parseInt(ri)));
  }

  // Re-create transfer arrow
  if(document.getElementById('zone-ph1')) ensureTransferArrow();

  // Re-create merge zones
  VS.mergeZones.forEach(mz => {
    ensureMergeZone(mz.passId, mz.groupId, mz.inputs);
    // rebuild buffers
    Object.keys(VS.bufs).forEach(key => {
      const [p,g,b] = key.split('-').map(Number);
      if(p===mz.passId && g===mz.groupId){
        getOrCreateBufCard(p, g, b);
        renderBufCard(p, g, b);
      }
    });
    // rebuild heap
    currentPassId  = mz.passId;
    currentGroupId = mz.groupId;
    currentHeapEl  = document.getElementById(`mz-${mz.passId}-${mz.groupId}-heap`);
    currentOutEl   = document.getElementById(`mz-${mz.passId}-${mz.groupId}-out`);
    currentOutCountEl = document.getElementById(`mz-${mz.passId}-${mz.groupId}-out-cnt`);
  });
  rebuildHeapDOM();
  renderOutput();

  // Rebuild log
  rebuildLogFromVS(VS.logEntries);

  // Update progress and phase badge
  updateProgress();
  updateHistoryBadge();

  log('â† Quay láº¡i bÆ°á»›c trÆ°á»›c', 'back', true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENT PROCESSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processEvent(ev){
  switch(ev.type){

    case 'params_chosen':
      statK.textContent  = ev.k ?? statK.textContent;
      statB.textContent  = ev.block_size ?? statB.textContent;
      sk.textContent     = ev.k ?? sk.textContent;
      sb.textContent     = ev.block_size ?? sb.textContent;
      if(ev.visualize_sample_size){
        statSample.textContent = ev.visualize_sample_size;
        fiSim.textContent = ev.visualize_sample_size+' sá»‘ máº«u';
        sbSimN.textContent = ev.visualize_sample_size;
        sbSimNPill.textContent = ev.visualize_sample_size;
      }
      if(ev.original_file_size){
        const mb = (ev.original_file_size/1024/1024).toFixed(2);
        const rn = Math.floor(ev.original_file_size/8);
        statFile.textContent = mb+' MB';
        fiSize.textContent   = mb+' MB';
        fiCount.textContent  = rn.toLocaleString()+' sá»‘';
        sbRealN.textContent  = rn.toLocaleString();
      }
      VS.phaseBadgeText = 'Tham sá»‘ Ä‘Ã£ chá»n';
      break;

    case 'meta':
      statK.textContent    = ev.k ?? statK.textContent;
      statB.textContent    = ev.block_size ?? statB.textContent;
      statRuns.textContent = ev.runs_count ?? statRuns.textContent;
      sk.textContent = ev.k ?? sk.textContent;
      sb.textContent = ev.block_size ?? sb.textContent;
      sr.textContent = ev.runs_count ?? sr.textContent;
      break;

    case 'file_info':
      fiName.textContent = ev.file_name || fiName.textContent;
      if(ev.file_size){
        const mb = (ev.file_size/1024/1024).toFixed(2);
        fiSize.textContent   = mb+' MB';
        fiCount.textContent  = Math.floor(ev.file_size/8).toLocaleString()+' sá»‘';
        statFile.textContent = mb+' MB';
      }
      log(`ğŸ’¾ File: ${ev.file_name} (${ev.file_size?(ev.file_size/1024/1024).toFixed(2)+' MB':'?'})`, 'disk');
      break;

    case 'read_block':{
      VS.phaseBadgeText = `Phase 1 â€” Run ${ev.run_index}`;
      if(!VS.runs[ev.run_index]) VS.runs[ev.run_index] = {nums:[], state:'unsorted', count:0};
      VS.runs[ev.run_index].nums  = ev.sample || [];
      VS.runs[ev.run_index].state = 'reading';
      VS.runs[ev.run_index].count = ev.count;
      renderRunCard(ev.run_index);
      flashTransfer(`ğŸ“– Äá»c ${ev.count} sá»‘ tá»« Disk vÃ o RAM`);
      log(`ğŸ’¾ Äá»c khá»‘i #${ev.run_index} â€” ${ev.count} pháº§n tá»­`, 'disk');
      break;
    }

    case 'sort_block':{
      VS.runs[ev.run_index].nums  = ev.sorted_sample || [];
      VS.runs[ev.run_index].state = 'sorted';
      renderRunCard(ev.run_index);
      log(`âœ“ Sort Run #${ev.run_index} trong RAM â†’ ghi láº¡i Disk`, 'ok');
      break;
    }

    case 'pass_info':
      VS.phaseBadgeText = `LÆ°á»£t trá»™n ${ev.pass_id}`;
      VS.outputCount = 0;
      log(`ğŸ”€ LÆ°á»£t trá»™n ${ev.pass_id} â€” ${ev.runs_before} runs, k=${ev.k}`, 'info');
      break;

    case 'merge_start':{
      ensureMergeZone(ev.pass_id, ev.group_id, ev.inputs);
      currentPassId  = ev.pass_id;
      currentGroupId = ev.group_id;
      currentHeapEl  = document.getElementById(`mz-${ev.pass_id}-${ev.group_id}-heap`);
      currentOutEl   = document.getElementById(`mz-${ev.pass_id}-${ev.group_id}-out`);
      currentOutCountEl = document.getElementById(`mz-${ev.pass_id}-${ev.group_id}-out-cnt`);
      // init buffers
      if(ev.input_buffers){
        ev.input_buffers.forEach((arr,i)=>{
          const key = getBufKey(ev.pass_id, ev.group_id, i);
          VS.bufs[key] = {nums: arr||[], usedCount:0, refilling:false};
          getOrCreateBufCard(ev.pass_id, ev.group_id, i);
          renderBufCard(ev.pass_id, ev.group_id, i);
        });
      }
      // init heap
      VS.heap = [];
      if(ev.initial_heap){
        ev.initial_heap.forEach(h=>{
          VS.heap.push({value: Array.isArray(h)?h[0]:h.value, src: String(Array.isArray(h)?h[1]:h.src)});
        });
      }
      rebuildHeapDOM();
      log(`ğŸ§  Merge báº¯t Ä‘áº§u: pass ${ev.pass_id} nhÃ³m ${ev.group_id}`, 'ram');
      break;
    }

    case 'heap_push':
      if(currentPassId!==null){
        currentHeapEl = document.getElementById(`mz-${currentPassId}-${currentGroupId}-heap`);
      }
      heapPush(ev.value, String(ev.src));

      // Pop & Shift: mark top of source buffer as used
      if(currentPassId!==null && ev.src!==undefined){
        bufPopTop(currentPassId, currentGroupId, ev.src);
        log(`ğŸ§  Push ${fmt(ev.value)} (s${ev.src}) â†’ Heap`, 'ram');
      }
      break;

    case 'heap_pop':
      if(currentPassId!==null){
        currentHeapEl = document.getElementById(`mz-${currentPassId}-${currentGroupId}-heap`);
      }
      heapPop(ev.value, String(ev.src));
      break;

    case 'output_emit':
      if(currentPassId!==null){
        currentOutEl      = document.getElementById(`mz-${currentPassId}-${currentGroupId}-out`);
        currentOutCountEl = document.getElementById(`mz-${currentPassId}-${currentGroupId}-out-cnt`);
      }
      emitOutput(ev.value);
      if(ev.emitted_count % 6 === 0){
        flashTransfer(`ğŸ’¾ Ghi ${fmt(ev.value)} â†’ Disk (${ev.emitted_count} pháº§n tá»­)`);
        log(`ğŸ’¾ Output: ${fmt(ev.value)} (tá»•ng ${ev.emitted_count})`, 'disk');
      }
      break;

    case 'input_buffer_update':
      if(ev.input_buffers && currentPassId!==null){
        ev.input_buffers.forEach((arr,i)=>{
          const key  = getBufKey(currentPassId, currentGroupId, i);
          const prev = VS.bufs[key];
          // Detect refill: new array length significantly larger than prev remaining
          const prevRemaining = prev ? (prev.nums.length - (prev.usedCount||0)) : 0;
          const isRefill = arr && arr.length > prevRemaining + 2;
          if(isRefill){
            bufRefill(currentPassId, currentGroupId, i, arr);
            flashTransfer(`â¬‡ Náº¡p ${arr.length} sá»‘ má»›i tá»« Disk vÃ o Buffer ${i}`);
            log(`ğŸ’¾ Buffer ${i} trá»‘ng â€” náº¡p ${arr.length} sá»‘ tiáº¿p tá»« Run ${i}`, 'disk');
          } else {
            VS.bufs[key] = {nums: arr||[], usedCount:0, refilling:false};
            renderBufCard(currentPassId, currentGroupId, i);
          }
        });
      }
      break;

    case 'merge_end':
      log(`âœ“ Merge xong pass ${ev.pass_id} nhÃ³m ${ev.group_id} â€” ${ev.merged_count} pháº§n tá»­`, 'ok');
      break;

    case 'finished':{
      VS.phaseBadgeText = 'âœ“ HoÃ n thÃ nh';
      log('ğŸ‰ Visualization hoÃ n thÃ nh!', 'ok');
      if(ev.final_preview?.length){
        const finZone = document.createElement('div');
        finZone.className = 'zone zone-disk';
        finZone.style.borderColor = 'rgba(34,211,160,.5)';
        finZone.innerHTML = `
          <div class="zone-header">
            <span class="zone-icon">âœ…</span>
            <span class="zone-title" style="color:var(--green)">Disk â€” Káº¿t quáº£ cuá»‘i (Ä‘Ã£ sáº¯p xáº¿p)</span>
            <span class="zone-desc">${ev.final_preview.length} sá»‘ (preview)</span>
          </div>
          <div class="output-wrap" style="border-color:rgba(34,211,160,.4)">
            <div class="out-header"><span class="out-title">Output sorted</span></div>
            <div class="out-stream" style="color:var(--green);max-height:80px;overflow:auto">
              ${ev.final_preview.map(v=>`<span>${fmt(v)}</span>`).join('  ')}
            </div>
          </div>`;
        stageContent.appendChild(finZone);
        stageContent.scrollTop = stageContent.scrollHeight;
      }
      paused = true;
      pauseBtn.textContent = 'â¸ Pause';
      pauseBtn.disabled    = true;
      break;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  handleStep â€” saves history before each step
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleStep(){
  if(animating || idx >= steps.length) return;
  // Save snapshot BEFORE processing this step
  pushHistory();
  VS.idx = idx;
  processEvent(steps[idx++]);
  VS.idx = idx;
  updateProgress();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYBACK LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tick(){
  if(paused || idx >= steps.length) return;
  handleStep();
  setTimeout(tick, Math.max(30, 360/speed));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
startBtn.onclick = ()=>{
  paused = false;
  startBtn.disabled = true;
  startBtn.classList.remove('btn-start-ready');
  guideArrow.classList.remove('show');
  pauseBtn.disabled = false;
  pauseBtn.textContent = 'â¸ Pause';
  tick();
};

pauseBtn.onclick = ()=>{
  paused = !paused;
  pauseBtn.textContent = paused ? 'â–¶ Resume' : 'â¸ Pause';
  if(!paused) tick();
};

stepBtn.onclick = ()=>{
  if(!paused){ paused = true; pauseBtn.textContent = 'â–¶ Resume'; }
  handleStep();
};

backBtn.onclick = ()=>{
  if(!history.length) return;
  if(!paused){ paused = true; pauseBtn.textContent = 'â–¶ Resume'; }
  const snap = history.pop();
  idx = snap.idx;
  restoreSnapshot(snap);
};

speedInput.oninput = ()=>{ speed=parseFloat(speedInput.value); speedLabel.textContent=speed+'Ã—'; };

document.addEventListener('keydown', e=>{
  if(e.target.tagName==='INPUT') return;
  if(e.code==='Space'){
    e.preventDefault();
    if(!startBtn.disabled && paused) startBtn.click();
    else pauseBtn.click();
  }
  if(e.key==='ArrowRight') stepBtn.click();
  if(e.key==='ArrowLeft')  backBtn.click();
});
</script>
</body>
</html>