<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>External Merge Sort â€” Visualizer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080c14;--surface:#0d1422;--card:#111926;
  --border:rgba(255,255,255,0.06);--text:#dde6f0;--muted:#5a7090;
  --cyan:#00d4ff;--violet:#8b5cf6;--green:#22d3a0;
  --orange:#f59e0b;--red:#f43f5e;--yellow:#fde047;
  --disk-bg:#06111f;--disk-border:#1e4080;
  --ram-bg:#0e0620;--ram-border:#5b21b6;
  --font-mono:'Space Mono',monospace;--font-body:'DM Sans',sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-body)}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:.4}

.app{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column;padding:20px;gap:16px;max-width:1500px;margin:0 auto}

/* â”€â”€ Header â”€â”€ */
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;align-items:baseline;gap:10px}
.brand-title{font-family:var(--font-mono);font-size:17px;font-weight:700;color:#fff}
.brand-tag{font-family:var(--font-mono);font-size:10px;color:var(--cyan);border:1px solid var(--cyan);padding:2px 7px;border-radius:4px;opacity:.7}
.upload-zone{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
#fileInput{display:none}
.file-label{display:flex;align-items:center;gap:7px;padding:7px 13px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:13px;color:var(--muted);transition:border-color .2s,color .2s}
.file-label:hover{border-color:var(--cyan);color:var(--text)}
#fileNameDisplay{font-size:12px;color:var(--muted);max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 15px;border-radius:8px;border:none;font-family:var(--font-body);font-size:13px;font-weight:500;cursor:pointer;transition:opacity .15s,transform .1s}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--cyan),var(--violet));color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{color:var(--text)}
.btn:disabled{opacity:.35;cursor:not-allowed;pointer-events:none}
.btn-dl{background:rgba(34,211,160,.12);border:1px solid rgba(34,211,160,.3);color:var(--green)}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .7s linear infinite;display:none}
.spinner.active{display:block}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Info bar â”€â”€ */
.info-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.info-pill{font-family:var(--font-mono);font-size:11px;padding:4px 10px;border-radius:20px;background:var(--card);border:1px solid var(--border);color:var(--muted)}
.info-pill span{color:var(--text);font-weight:700}
.info-pill.cyan span{color:var(--cyan)}
.info-pill.violet span{color:var(--violet)}
.info-pill.green span{color:var(--green)}
.phase-badge{font-family:var(--font-mono);font-size:11px;padding:4px 12px;border-radius:20px;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);color:var(--cyan);margin-left:auto}

/* â”€â”€ Progress bar â”€â”€ */
.progress-bar-wrap{display:flex;align-items:center;gap:10px}
.progress-track{flex:1;height:5px;background:rgba(255,255,255,.05);border-radius:5px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--violet));border-radius:5px;width:0%;transition:width .25s}
.progress-text{font-family:var(--font-mono);font-size:11px;color:var(--muted);white-space:nowrap}

/* â”€â”€ Main 2-col layout â”€â”€ */
.main{display:grid;grid-template-columns:1fr 300px;gap:14px;flex:1;align-items:start}

/* â”€â”€ Stage â”€â”€ */
.stage{display:flex;flex-direction:column;gap:14px}

/* â”€â”€ Disk / RAM zones â”€â”€ */
.zone{border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px}
.zone-disk{background:var(--disk-bg);border:1px dashed var(--disk-border)}
.zone-ram{background:var(--ram-bg);border:1px solid var(--ram-border)}
.zone-header{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.zone-icon{font-size:14px}
.zone-title{font-family:var(--font-mono);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.12em}
.zone-disk .zone-title{color:var(--disk-border)}
.zone-ram .zone-title{color:var(--ram-border)}
.zone-desc{font-size:11px;color:var(--muted);margin-left:auto}

/* â”€â”€ Transfer arrow between zones â”€â”€ */
.transfer-arrow{display:flex;align-items:center;justify-content:center;gap:8px;padding:4px 0}
.transfer-arrow-line{flex:1;height:1px;background:linear-gradient(90deg,var(--disk-border),var(--ram-border))}
.transfer-arrow-label{font-family:var(--font-mono);font-size:10px;color:var(--muted);white-space:nowrap;padding:3px 10px;border-radius:10px;background:var(--card);border:1px solid var(--border)}
.transfer-arrow-label.active{color:var(--yellow);border-color:var(--yellow);background:rgba(253,224,71,.05);animation:pulse-border 1s ease-in-out infinite}
@keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(253,224,71,.3)}50%{box-shadow:0 0 0 4px rgba(253,224,71,.1)}}

/* â”€â”€ Run cards (disk) â”€â”€ */
.runs-row{display:flex;gap:10px;flex-wrap:wrap}
.run-card{background:#0a1825;border:1px solid rgba(30,64,128,.4);border-radius:10px;padding:10px 12px;min-width:150px;max-width:220px;transition:border-color .25s,background .25s}
.run-card.reading{border-color:var(--yellow);background:rgba(253,224,71,.04)}
.run-card.sorted{border-color:rgba(34,211,160,.5);background:rgba(34,211,160,.03)}
.run-card.exhausted{opacity:.4;border-color:var(--border)}
.run-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.run-card-title{font-family:var(--font-mono);font-size:10px;color:var(--muted)}
.run-card-count{font-family:var(--font-mono);font-size:9px;color:var(--muted);opacity:.7}
.run-card-status{font-size:9px;font-family:var(--font-mono);padding:1px 6px;border-radius:8px}
.status-unsorted{background:rgba(245,158,11,.15);color:var(--orange);border:1px solid rgba(245,158,11,.2)}
.status-sorted{background:rgba(34,211,160,.15);color:var(--green);border:1px solid rgba(34,211,160,.2)}
.status-reading{background:rgba(253,224,71,.15);color:var(--yellow);border:1px solid rgba(253,224,71,.2)}
.status-done{background:rgba(90,112,144,.15);color:var(--muted);border:1px solid rgba(90,112,144,.2)}

/* Numbers display in run card */
.run-numbers{font-family:var(--font-mono);font-size:10px;color:#4a8fa8;line-height:1.6;min-height:18px;word-break:break-all}
.run-numbers .num-highlight{color:var(--yellow);font-weight:700}
.run-numbers .num-sorted{color:var(--green)}
.run-read-progress{height:3px;background:rgba(255,255,255,.05);border-radius:3px;margin-top:6px;overflow:hidden}
.run-read-fill{height:100%;background:linear-gradient(90deg,var(--yellow),var(--orange));border-radius:3px;width:0%;transition:width .4s}

/* â”€â”€ Buffer cards (RAM) â”€â”€ */
.buffer-card{background:#0e0820;border:1px solid rgba(91,33,182,.4);border-radius:10px;padding:10px 12px;min-width:150px;max-width:220px;transition:border-color .25s}
.buffer-card.active{border-color:var(--violet)}
.buffer-card.empty{opacity:.5}
.buffer-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.buffer-card-title{font-family:var(--font-mono);font-size:10px;color:#8b6fd4}
.buffer-numbers{font-family:var(--font-mono);font-size:10px;color:#9d7eed;line-height:1.6;min-height:18px;word-break:break-all}
.buffer-numbers .buf-top{color:var(--violet);font-weight:700;font-size:11px}
.buffer-refill-label{font-size:9px;color:var(--yellow);font-family:var(--font-mono);margin-top:4px;display:none}
.buffer-refill-label.show{display:block;animation:blink .6s steps(1) infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ Heap (RAM) â”€â”€ */
.heap-wrap{background:rgba(0,0,0,.2);border:1px solid rgba(91,33,182,.25);border-radius:10px;padding:12px}
.heap-title{font-family:var(--font-mono);font-size:10px;color:#8b6fd4;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px}
.heap-nodes{display:flex;gap:6px;flex-wrap:wrap;min-height:40px;align-items:center}
.heap-node{
  font-family:var(--font-mono);font-size:11px;padding:5px 9px;border-radius:6px;
  background:linear-gradient(135deg,rgba(139,92,246,.2),rgba(244,63,94,.15));
  border:1px solid rgba(139,92,246,.3);color:#c4b5fd;
  opacity:0;transform:translateY(6px);transition:opacity .2s,transform .2s,border-color .2s,background .2s
}
.heap-node.visible{opacity:1;transform:translateY(0)}
.heap-node.heap-min{background:linear-gradient(135deg,rgba(244,63,94,.3),rgba(245,158,11,.2));border-color:var(--red);color:#fff;font-weight:700}
.heap-node.popping{opacity:0;transform:translateY(-12px) scale(.85);transition:opacity .18s,transform .18s}
.heap-label{font-size:9px;font-family:var(--font-mono);color:var(--muted);margin-top:6px}

/* â”€â”€ Output (disk) â”€â”€ */
.output-wrap{background:#06111f;border:1px dashed rgba(34,211,160,.3);border-radius:10px;padding:12px}
.output-title{font-family:var(--font-mono);font-size:10px;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
.output-count{color:var(--muted);font-size:9px}
.output-numbers{font-family:var(--font-mono);font-size:10px;color:rgba(34,211,160,.7);line-height:1.7;min-height:28px;max-height:60px;overflow:hidden;word-break:break-all}
.output-numbers .out-latest{color:var(--green);font-weight:700}

/* â”€â”€ Flying token â”€â”€ */
.flying-token{
  position:fixed;z-index:9999;pointer-events:none;
  font-family:var(--font-mono);font-size:11px;font-weight:700;
  padding:4px 8px;border-radius:6px;
  background:var(--yellow);color:#000;
  box-shadow:0 0 12px rgba(253,224,71,.6);
  transition:none;will-change:transform,opacity
}

/* â”€â”€ Merge section â”€â”€ */
.merge-section{display:flex;flex-direction:column;gap:10px}
.merge-section-title{font-family:var(--font-mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;padding:4px 0;border-bottom:1px solid var(--border)}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{display:flex;flex-direction:column;gap:12px;position:sticky;top:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px}
.card-title{font-family:var(--font-mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px}

/* File info */
.file-info-block{display:flex;flex-direction:column;gap:6px}
.fi-row{display:flex;justify-content:space-between;align-items:center;font-size:12px}
.fi-label{color:var(--muted)}
.fi-val{font-family:var(--font-mono);font-size:11px;color:var(--text)}
.fi-val.accent{color:var(--cyan)}

/* Stats */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-box{background:var(--card);border-radius:8px;padding:9px 11px}
.stat-label{font-size:10px;color:var(--muted);margin-bottom:3px}
.stat-val{font-family:var(--font-mono);font-size:17px;font-weight:700}
.stat-val.cyan{color:var(--cyan)}
.stat-val.violet{color:var(--violet)}
.stat-val.green{color:var(--green)}
.stat-hint{font-size:9px;color:var(--muted);margin-top:2px}

/* Controls */
.ctrl-row{display:flex;gap:7px;flex-wrap:wrap}
.speed-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.speed-row label{font-size:11px;color:var(--muted);font-family:var(--font-mono);white-space:nowrap}
input[type=range]{flex:1;-webkit-appearance:none;height:4px;background:rgba(255,255,255,.08);border-radius:4px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--cyan);cursor:pointer}
.hints{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.hint{font-size:10px;color:var(--muted)}
.hint kbd{font-family:var(--font-mono);background:var(--card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:9px;color:var(--text)}

/* Log */
.log-list{font-family:var(--font-mono);font-size:10px;color:var(--muted);display:flex;flex-direction:column;gap:3px;max-height:200px;overflow-y:auto}
.log-list::-webkit-scrollbar{width:3px}
.log-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.log-row{display:flex;gap:6px;line-height:1.5}
.log-t{opacity:.4;flex-shrink:0}
.log-row.info .log-m{color:var(--cyan)}
.log-row.ok   .log-m{color:var(--green)}
.log-row.warn .log-m{color:var(--orange)}
.log-row.disk .log-m{color:#4a8fa8}
.log-row.ram  .log-m{color:#9d7eed}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:60px 20px;opacity:.3}
.empty-state p{font-size:13px;color:var(--muted);font-family:var(--font-mono)}

@media(max-width:900px){
  .main{grid-template-columns:1fr}
  .sidebar{position:static}
}
</style>
</head>
<body>
<div class="app">

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <div class="brand">
    <span class="brand-title">ext_merge_sort</span>
    <span class="brand-tag">VISUALIZER</span>
  </div>
  <div class="upload-zone">
    <input type="file" id="fileInput" accept=".bin"/>
    <label class="file-label" for="fileInput">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Chá»n file .bin
    </label>
    <span id="fileNameDisplay">ChÆ°a chá»n file</span>
    <div class="spinner" id="spinner"></div>
    <button class="btn btn-primary" id="uploadBtn" disabled>Visualize</button>
    <button class="btn btn-dl" id="downloadBtn" style="display:none">â†“ Download sorted</button>
  </div>
</header>

<!-- â”€â”€ INFO BAR â”€â”€ -->
<div class="info-bar" id="infoBar" style="display:none">
  <div class="info-pill cyan">k-way <span id="statK">â€”</span></div>
  <div class="info-pill violet">block_size <span id="statB">â€”</span></div>
  <div class="info-pill">Runs <span id="statRuns">â€”</span></div>
  <div class="info-pill">Sample <span id="statSample">â€”</span> sá»‘</div>
  <div class="info-pill green">File <span id="statFile">â€”</span></div>
  <div class="phase-badge" id="phaseBadge">Chá» upload...</div>
</div>

<!-- â”€â”€ PROGRESS â”€â”€ -->
<div class="progress-bar-wrap" id="progressWrap" style="display:none">
  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
  <span class="progress-text" id="progressText">0 / 0</span>
</div>

<!-- â”€â”€ MAIN â”€â”€ -->
<div class="main">

  <!-- STAGE -->
  <div class="stage" id="stage">
    <div class="empty-state" id="emptyState">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
      </svg>
      <p>Upload file .bin Ä‘á»ƒ báº¯t Ä‘áº§u</p>
    </div>
    <div id="stageContent" style="display:none;flex-direction:column;gap:14px"></div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">

    <!-- File info -->
    <div class="card" id="fileCard" style="display:none">
      <div class="card-title">ğŸ“ ThÃ´ng tin File</div>
      <div class="file-info-block">
        <div class="fi-row"><span class="fi-label">TÃªn file</span><span class="fi-val accent" id="fiName">â€”</span></div>
        <div class="fi-row"><span class="fi-label">KÃ­ch thÆ°á»›c</span><span class="fi-val" id="fiSize">â€”</span></div>
        <div class="fi-row"><span class="fi-label">Tá»•ng sá»‘ pháº§n tá»­</span><span class="fi-val" id="fiCount">â€”</span></div>
      </div>
    </div>

    <!-- Params -->
    <div class="card" id="paramsCard" style="display:none">
      <div class="card-title">âš™ï¸ Tham sá»‘ thuáº­t toÃ¡n</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">k-way merge</div>
          <div class="stat-val cyan" id="sk">â€”</div>
          <div class="stat-hint">merge k run cÃ¹ng lÃºc</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">block_size</div>
          <div class="stat-val violet" id="sb">â€”</div>
          <div class="stat-hint">sá»‘/láº§n Ä‘á»c disk</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Sá»‘ runs</div>
          <div class="stat-val green" id="sr">â€”</div>
          <div class="stat-hint">runs ban Ä‘áº§u</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">RAM tá»‘i Ä‘a</div>
          <div class="stat-val" id="sram" style="font-size:13px">â€”</div>
          <div class="stat-hint">k Ã— buffer + heap</div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="card-title">ğŸ® Äiá»u khiá»ƒn</div>
      <div class="ctrl-row">
        <button class="btn btn-ghost" id="startBtn" disabled>â–¶ Start</button>
        <button class="btn btn-ghost" id="pauseBtn" disabled>â¸ Pause</button>
        <button class="btn btn-ghost" id="stepBtn" disabled>â­ Step</button>
      </div>
      <div class="speed-row">
        <label>Speed</label>
        <input type="range" id="speedInput" min="0.25" max="4" step="0.25" value="1"/>
        <span style="font-family:var(--font-mono);font-size:11px;color:var(--cyan);min-width:28px" id="speedLabel">1Ã—</span>
      </div>
      <div class="hints">
        <span class="hint"><kbd>Space</kbd> pause</span>
        <span class="hint"><kbd>â†’</kbd> step</span>
      </div>
    </div>

    <!-- Event Log -->
    <div class="card" style="flex:1">
      <div class="card-title">ğŸ“‹ Event Log</div>
      <div class="log-list" id="logList"></div>
    </div>

  </div><!-- /sidebar -->
</div><!-- /main -->
</div><!-- /app -->

<script>
// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fileInput    = document.getElementById('fileInput');
const fileNameDisp = document.getElementById('fileNameDisplay');
const uploadBtn    = document.getElementById('uploadBtn');
const downloadBtn  = document.getElementById('downloadBtn');
const spinner      = document.getElementById('spinner');
const infoBar      = document.getElementById('infoBar');
const progressWrap = document.getElementById('progressWrap');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const phaseBadge   = document.getElementById('phaseBadge');
const emptyState   = document.getElementById('emptyState');
const stageContent = document.getElementById('stageContent');
const fileCard     = document.getElementById('fileCard');
const paramsCard   = document.getElementById('paramsCard');
const startBtn     = document.getElementById('startBtn');
const pauseBtn     = document.getElementById('pauseBtn');
const stepBtn      = document.getElementById('stepBtn');
const speedInput   = document.getElementById('speedInput');
const speedLabel   = document.getElementById('speedLabel');
const logList      = document.getElementById('logList');

// sidebar stat els
const statK    = document.getElementById('statK');
const statB    = document.getElementById('statB');
const statRuns = document.getElementById('statRuns');
const statSample= document.getElementById('statSample');
const statFile = document.getElementById('statFile');
const sk = document.getElementById('sk');
const sb = document.getElementById('sb');
const sr = document.getElementById('sr');
const sram = document.getElementById('sram');
const fiName = document.getElementById('fiName');
const fiSize = document.getElementById('fiSize');
const fiCount = document.getElementById('fiCount');

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let steps = [], idx = 0, paused = true, speed = 1, totalSteps = 0, jobId = null;
let currentPassId = null, currentGroupId = null;
// track run data for display
const runData   = {};   // runIdx â†’ {nums, count, readPos}
const bufData   = {};   // bufIdx â†’ {nums}
let outputCount = 0;
let outputNumsEl = null;
let heapNodesEl  = null;
let transferArrowEl = null;

// â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type=''){
  const row = document.createElement('div');
  row.className = 'log-row' + (type ? ' '+type : '');
  const t = new Date().toLocaleTimeString('vi',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  row.innerHTML = `<span class="log-t">${t}</span><span class="log-m">${msg}</span>`;
  logList.prepend(row);
  while(logList.children.length > 100) logList.removeChild(logList.lastChild);
}

// â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateProgress(){
  const pct = totalSteps ? Math.round(idx/totalSteps*100) : 0;
  progressFill.style.width = pct + '%';
  progressText.textContent = `${idx} / ${totalSteps}`;
}

// â”€â”€ Number formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(v){ return Number(v).toFixed(1); }
function fmtNums(arr, max=5){
  if(!arr||!arr.length) return '<span style="opacity:.4">trá»‘ng</span>';
  const shown = arr.slice(0, max).map(v => fmt(v));
  return shown.join('  ') + (arr.length > max ? `  <span style="opacity:.5">+${arr.length-max}...</span>` : '');
}

// â”€â”€ File picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fileInput.onchange = () => {
  const f = fileInput.files[0];
  if(!f) return;
  fileNameDisp.textContent = f.name;
  uploadBtn.disabled = false;
};

// â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
uploadBtn.onclick = async () => {
  const f = fileInput.files[0];
  if(!f){ alert('Chá»n file .bin trÆ°á»›c'); return; }
  uploadBtn.disabled = true;
  spinner.classList.add('active');
  downloadBtn.style.display = 'none';
  phaseBadge.textContent = 'Äang upload...';
  log('Äang upload & xá»­ lÃ½...', 'info');

  const fd = new FormData();
  fd.append('file', f);
  let vizData;
  try{
    const r = await fetch('/sort/visualize', {method:'POST', body:fd});
    if(!r.ok){
      const err = await r.json().catch(()=>({detail:r.statusText}));
      throw new Error(err.detail || r.statusText);
    }
    vizData = await r.json();
  } catch(e){
    log('Lá»—i: '+e.message, 'warn');
    spinner.classList.remove('active');
    uploadBtn.disabled = false;
    phaseBadge.textContent = 'Lá»—i';
    return;
  }

  if(vizData.job_id){
    jobId = vizData.job_id;
    pollForDownload(jobId);
  }

  steps      = vizData.steps || [];
  totalSteps = steps.length;
  idx        = 0;
  resetStage();

  // Fill info bar
  const meta   = vizData.meta || steps.find(s=>s.type==='meta');
  const params = steps.find(s=>s.type==='params_chosen');
  if(meta){
    statK.textContent    = meta.k ?? 'â€”';
    statB.textContent    = meta.block_size ?? 'â€”';
    statRuns.textContent = meta.runs_count ?? 'â€”';
    sk.textContent = meta.k ?? 'â€”';
    sb.textContent = meta.block_size ?? 'â€”';
    sr.textContent = meta.runs_count ?? 'â€”';
  }
  if(params){
    statSample.textContent = params.visualize_sample_size ?? 'â€”';
    const k = meta?.k ?? params.k ?? 4;
    const bs = meta?.block_size ?? params.block_size ?? 0;
    sram.textContent = `â‰¤ ${k * bs + k} sá»‘`;
    if(params.original_file_size){
      const mb = (params.original_file_size/1024/1024).toFixed(2);
      statFile.textContent = mb + ' MB';
      fiSize.textContent   = mb + ' MB';
      fiCount.textContent  = Math.floor(params.original_file_size/8).toLocaleString() + ' sá»‘';
    }
  }
  fiName.textContent = f.name;
  infoBar.style.display      = 'flex';
  progressWrap.style.display = 'flex';
  fileCard.style.display     = 'block';
  paramsCard.style.display   = 'block';

  spinner.classList.remove('active');
  phaseBadge.textContent = 'Sáºµn sÃ ng';
  log(`Nháº­n ${steps.length} steps â€” nháº¥n Start Ä‘á»ƒ xem`, 'ok');
  updateProgress();
  startBtn.disabled = false;
  stepBtn.disabled  = false;
};

// â”€â”€ Poll download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollForDownload(jid){
  const setBtn = (label, ready) => {
    downloadBtn.textContent = label;
    downloadBtn.style.display = 'inline-flex';
    downloadBtn.style.opacity  = ready ? '1' : '0.5';
    downloadBtn.style.cursor   = ready ? 'pointer' : 'default';
    downloadBtn.onclick = ready ? () => window.location=`/download/${jid}` : null;
  };
  setBtn('â³ Äang sort...', false);
  const poll = async () => {
    try{
      const r = await fetch(`/status/${jid}`);
      if(!r.ok){ setTimeout(poll, 2000); return; }
      const d = await r.json();
      if(d.status === 'done'){ setBtn('â†“ Download sorted', true); log('âœ“ Sort tháº­t xong â€” sáºµn sÃ ng download', 'ok'); }
      else if(d.status?.startsWith('error')){ downloadBtn.style.display='none'; log('Sort lá»—i: '+d.status,'warn'); }
      else{ setBtn(d.status==='processing'?'â³ Sorting...':'â³ Queued...', false); setTimeout(poll,1500); }
    } catch(e){ setTimeout(poll,3000); }
  };
  poll();
}

// â”€â”€ Reset stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetStage(){
  stageContent.innerHTML = '';
  stageContent.style.display = 'flex';
  emptyState.style.display   = 'none';
  Object.keys(runData).forEach(k=>delete runData[k]);
  Object.keys(bufData).forEach(k=>delete bufData[k]);
  outputCount    = 0;
  outputNumsEl   = null;
  heapNodesEl    = null;
  transferArrowEl= null;
  currentPassId  = null;
  currentGroupId = null;
}

// â”€â”€ Build Phase 1 (Disk zone) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ensurePhase1(){
  if(document.getElementById('zone-disk-ph1')) return;
  const zone = document.createElement('div');
  zone.className = 'zone zone-disk';
  zone.id = 'zone-disk-ph1';
  zone.innerHTML = `
    <div class="zone-header">
      <span class="zone-icon">ğŸ’¾</span>
      <span class="zone-title">Disk â€” Bá»™ nhá»› ngoÃ i</span>
      <span class="zone-desc">Dá»¯ liá»‡u quÃ¡ lá»›n Ä‘á»ƒ giá»¯ trong RAM</span>
    </div>
    <div class="merge-section-title">Phase 1 â€” Táº¡o Initial Runs</div>
    <div class="runs-row" id="ph1-runs"></div>`;
  stageContent.appendChild(zone);
}

function getOrCreateRunCard(runIdx){
  if(runData[runIdx]?.card) return runData[runIdx];
  ensurePhase1();
  const row  = document.getElementById('ph1-runs');
  const card = document.createElement('div');
  card.className = 'run-card';
  card.id = `run-card-${runIdx}`;
  card.innerHTML = `
    <div class="run-card-header">
      <span class="run-card-title">ğŸ’¾ Run ${runIdx}</span>
      <span class="run-card-status status-unsorted" id="run-status-${runIdx}">chÆ°a sort</span>
    </div>
    <div class="run-numbers" id="run-nums-${runIdx}">â€”</div>
    <div class="run-read-progress"><div class="run-read-fill" id="run-fill-${runIdx}"></div></div>`;
  row.appendChild(card);
  runData[runIdx] = { card, numsEl: document.getElementById(`run-nums-${runIdx}`),
                      statusEl: document.getElementById(`run-status-${runIdx}`),
                      fillEl: document.getElementById(`run-fill-${runIdx}`),
                      count: 0, readPct: 0 };
  return runData[runIdx];
}

function updateRunCard(runIdx, nums, state, count){
  const rc = getOrCreateRunCard(runIdx);
  if(count !== undefined) rc.count = count;

  // numbers display
  if(nums && nums.length){
    const displayed = nums.slice(0,6);
    rc.numsEl.innerHTML = displayed.map((v,i)=>
      `<span class="${i===0&&state==='reading'?'num-highlight':state==='sorted'?'num-sorted':''}">${fmt(v)}</span>`
    ).join('  ') + (nums.length>6 ? `  <span style="opacity:.4">...</span>` : '');
  }

  // status badge
  const statusMap = {
    reading: ['status-reading','ğŸ“– Ä‘á»c vÃ o RAM'],
    sorted:  ['status-sorted', 'âœ“ Ä‘Ã£ sort'],
    done:    ['status-done',   'âœ“ xong'],
  };
  if(statusMap[state]){
    rc.statusEl.className = 'run-card-status '+statusMap[state][0];
    rc.statusEl.textContent = statusMap[state][1];
    rc.card.className = 'run-card ' + (state==='reading'?'reading':state==='sorted'?'sorted':'');
  }
}

// â”€â”€ Transfer arrow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ensureTransferArrow(){
  if(document.getElementById('transfer-arrow')) return;
  const wrap = document.createElement('div');
  wrap.className = 'transfer-arrow';
  wrap.id = 'transfer-arrow';
  wrap.innerHTML = `
    <div class="transfer-arrow-line"></div>
    <div class="transfer-arrow-label" id="transfer-label">ğŸ’¾ Disk â†’ ğŸ§  RAM</div>
    <div class="transfer-arrow-line"></div>`;
  stageContent.appendChild(wrap);
  transferArrowEl = document.getElementById('transfer-label');
}

function flashTransfer(msg){
  ensureTransferArrow();
  if(!transferArrowEl) return;
  transferArrowEl.textContent = msg;
  transferArrowEl.classList.add('active');
  setTimeout(()=>transferArrowEl?.classList.remove('active'), 1200);
}

// â”€â”€ Build Merge zone (RAM) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ensureMergeZone(passId, groupId, inputNames){
  const id = `merge-${passId}-${groupId}`;
  if(document.getElementById(id)) return;

  ensureTransferArrow();

  const zone = document.createElement('div');
  zone.className = 'zone zone-ram';
  zone.id = id;
  zone.innerHTML = `
    <div class="zone-header">
      <span class="zone-icon">ğŸ§ </span>
      <span class="zone-title">RAM â€” Bá»™ nhá»› trong</span>
      <span class="zone-desc">LÆ°á»£t trá»™n ${passId}, nhÃ³m ${groupId}</span>
    </div>
    <div class="merge-section-title">Input Buffers (Ä‘á»c tá»« Disk vÃ o RAM)</div>
    <div class="runs-row" id="${id}-bufs"></div>
    <div class="merge-section-title" style="margin-top:4px">Min-Heap (so sÃ¡nh trong RAM)</div>
    <div class="heap-wrap">
      <div class="heap-nodes" id="${id}-heap"></div>
      <div class="heap-label">Pháº§n tá»­ nhá» nháº¥t luÃ´n á»Ÿ Ä‘áº§u â†’ ghi ra Output</div>
    </div>`;

  stageContent.appendChild(zone);

  // Output disk zone
  const outZone = document.createElement('div');
  outZone.className = 'zone zone-disk';
  outZone.id = `${id}-out-zone`;
  outZone.innerHTML = `
    <div class="zone-header">
      <span class="zone-icon">ğŸ’¾</span>
      <span class="zone-title">Disk â€” Output</span>
      <span class="zone-desc">Ghi káº¿t quáº£ Ä‘Ã£ merge ra Disk</span>
    </div>
    <div class="output-wrap">
      <div class="output-title">
        <span>Luá»“ng output (Ä‘Ã£ sáº¯p xáº¿p)</span>
        <span class="output-count" id="${id}-out-count">0 pháº§n tá»­</span>
      </div>
      <div class="output-numbers" id="${id}-out-nums"></div>
    </div>`;
  stageContent.appendChild(outZone);

  stageContent.scrollTop = stageContent.scrollHeight;

  heapNodesEl  = document.getElementById(`${id}-heap`);
  outputNumsEl = document.getElementById(`${id}-out-nums`);
  currentPassId  = passId;
  currentGroupId = groupId;
}

function ensureCurrentRefs(){
  if(currentPassId===null) return;
  const id = `merge-${currentPassId}-${currentGroupId}`;
  heapNodesEl  = document.getElementById(`${id}-heap`);
  outputNumsEl = document.getElementById(`${id}-out-nums`);
}

// â”€â”€ Build buffer cards (RAM) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getOrCreateBufferCard(passId, groupId, bufIdx){
  const id = `buf-${passId}-${groupId}-${bufIdx}`;
  if(document.getElementById(id)) return document.getElementById(id);
  const mergeId = `merge-${passId}-${groupId}`;
  const bufsRow = document.getElementById(`${mergeId}-bufs`);
  if(!bufsRow) return null;
  const card = document.createElement('div');
  card.className = 'buffer-card';
  card.id = id;
  card.innerHTML = `
    <div class="buffer-card-header">
      <span class="buffer-card-title">ğŸ§  Buffer ${bufIdx}</span>
      <span style="font-size:9px;color:var(--muted);font-family:var(--font-mono)">tá»« Run ${bufIdx}</span>
    </div>
    <div class="buffer-numbers" id="${id}-nums">â€”</div>
    <div class="buffer-refill-label" id="${id}-refill">â†‘ náº¡p tá»« Disk...</div>`;
  bufsRow.appendChild(card);
  return card;
}

function updateBufferCard(passId, groupId, bufIdx, nums, refilling=false){
  const id   = `buf-${passId}-${groupId}-${bufIdx}`;
  const card = document.getElementById(id) || getOrCreateBufferCard(passId, groupId, bufIdx);
  if(!card) return;
  const numsEl   = document.getElementById(`${id}-nums`);
  const refillEl = document.getElementById(`${id}-refill`);
  if(!numsEl) return;

  if(!nums || !nums.length){
    numsEl.innerHTML = '<span style="opacity:.4">háº¿t dá»¯ liá»‡u</span>';
    card.classList.add('empty');
  } else {
    card.classList.remove('empty');
    const top  = nums[0];
    const rest = nums.slice(1, 5);
    numsEl.innerHTML =
      `<span class="buf-top">${fmt(top)}</span>` +
      (rest.length ? '  ' + rest.map(v=>fmt(v)).join('  ') : '') +
      (nums.length > 5 ? `  <span style="opacity:.4">+${nums.length-5}...</span>` : '');
    card.classList.toggle('active', !refilling);
  }
  if(refillEl) refillEl.classList.toggle('show', refilling);
}

// â”€â”€ Heap animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pushHeapNode(value, src){
  if(!heapNodesEl) return;
  // remove existing if same value+src (prevent duplication)
  const existing = Array.from(heapNodesEl.children)
    .find(n=>n.dataset.val==value && n.dataset.src==String(src));
  if(existing) return;

  const node = document.createElement('div');
  node.className = 'heap-node';
  node.dataset.val = value;
  node.dataset.src = src;
  node.textContent = `${fmt(value)} (s${src})`;
  heapNodesEl.appendChild(node);
  requestAnimationFrame(()=>node.classList.add('visible'));

  // Highlight min
  highlightHeapMin();
  while(heapNodesEl.children.length > 20) heapNodesEl.removeChild(heapNodesEl.children[0]);
}

function popHeapNode(value, src){
  if(!heapNodesEl) return;
  const nodes = Array.from(heapNodesEl.children);
  const found = nodes.find(n=>n.dataset.val==value && n.dataset.src==String(src));
  const target = found || nodes[0];
  if(!target) return;
  target.classList.add('popping');
  setTimeout(()=>{ target.parentNode?.removeChild(target); highlightHeapMin(); }, 200);
}

function highlightHeapMin(){
  if(!heapNodesEl) return;
  const nodes = Array.from(heapNodesEl.children);
  // find smallest
  let minNode = null, minVal = Infinity;
  nodes.forEach(n=>{
    const v = parseFloat(n.dataset.val);
    if(v < minVal){ minVal = v; minNode = n; }
  });
  nodes.forEach(n=>n.classList.remove('heap-min'));
  if(minNode) minNode.classList.add('heap-min');
}

// â”€â”€ Output emit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function emitOutput(value){
  if(!outputNumsEl) return;
  outputCount++;
  const countEl = outputNumsEl.closest('.output-wrap')?.querySelector('.output-count');
  if(countEl) countEl.textContent = outputCount + ' pháº§n tá»­';

  // Keep last ~30 numbers shown
  const span = document.createElement('span');
  span.className = 'out-latest';
  span.textContent = fmt(value) + '  ';
  outputNumsEl.appendChild(span);
  requestAnimationFrame(()=>{ span.style.color = 'var(--green)'; });
  setTimeout(()=>{ span.style.color = 'rgba(34,211,160,.6)'; span.className=''; }, 600);

  // trim old
  while(outputNumsEl.children.length > 40) outputNumsEl.removeChild(outputNumsEl.children[0]);
}

// â”€â”€ Flying token animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flyToken(fromEl, toEl, value, onDone){
  if(!fromEl || !toEl){ onDone?.(); return; }
  const fr = fromEl.getBoundingClientRect();
  const tr = toEl.getBoundingClientRect();
  const token = document.createElement('div');
  token.className = 'flying-token';
  token.textContent = fmt(value);
  token.style.left = (fr.left + fr.width/2) + 'px';
  token.style.top  = (fr.top  + fr.height/2) + 'px';
  document.body.appendChild(token);

  const dx = (tr.left + tr.width/2)  - (fr.left + fr.width/2);
  const dy = (tr.top  + tr.height/2) - (fr.top  + fr.height/2);
  const dur = Math.min(500, Math.max(200, Math.sqrt(dx*dx+dy*dy)*0.5));

  token.animate([
    {transform:'translate(0,0) scale(1)',  opacity:1},
    {transform:`translate(${dx}px,${dy}px) scale(0.8)`, opacity:0}
  ],{duration:dur, easing:'ease-in'}).onfinish = ()=>{
    token.remove();
    onDone?.();
  };
}

// â”€â”€ Event processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processEvent(ev){
  switch(ev.type){

    case 'params_chosen':
      statK.textContent  = ev.k ?? statK.textContent;
      statB.textContent  = ev.block_size ?? statB.textContent;
      sk.textContent     = ev.k ?? sk.textContent;
      sb.textContent     = ev.block_size ?? sb.textContent;
      if(ev.visualize_sample_size) statSample.textContent = ev.visualize_sample_size;
      if(ev.original_file_size){
        const mb = (ev.original_file_size/1024/1024).toFixed(2);
        statFile.textContent = mb+' MB';
        fiSize.textContent   = mb+' MB';
        fiCount.textContent  = Math.floor(ev.original_file_size/8).toLocaleString()+' sá»‘';
      }
      phaseBadge.textContent = 'Tham sá»‘ Ä‘Ã£ chá»n';
      break;

    case 'meta':
      statK.textContent    = ev.k ?? statK.textContent;
      statB.textContent    = ev.block_size ?? statB.textContent;
      statRuns.textContent = ev.runs_count ?? statRuns.textContent;
      sk.textContent       = ev.k ?? sk.textContent;
      sb.textContent       = ev.block_size ?? sb.textContent;
      sr.textContent       = ev.runs_count ?? sr.textContent;
      break;

    case 'file_info':
      fiName.textContent = ev.file_name || fiName.textContent;
      if(ev.file_size){
        const mb = (ev.file_size/1024/1024).toFixed(2);
        fiSize.textContent  = mb+' MB';
        fiCount.textContent = Math.floor(ev.file_size/8).toLocaleString()+' sá»‘';
        statFile.textContent= mb+' MB';
      }
      log(`ğŸ’¾ File: ${ev.file_name} (${ev.file_size?(ev.file_size/1024/1024).toFixed(2)+' MB':'?'})`, 'disk');
      break;

    case 'read_block':{
      phaseBadge.textContent = `Phase 1 â€” Run ${ev.run_index}`;
      updateRunCard(ev.run_index, ev.sample, 'reading', ev.count);
      flashTransfer(`ğŸ“– Äá»c ${ev.count} sá»‘ tá»« Disk â†’ RAM`);
      log(`ğŸ’¾ Äá»c khá»‘i #${ev.run_index} â€” ${ev.count} pháº§n tá»­ vÃ o RAM`, 'disk');
      break;
    }

    case 'sort_block':{
      updateRunCard(ev.run_index, ev.sorted_sample, 'sorted', ev.count);
      log(`âœ“ ÄÃ£ sort Run #${ev.run_index} trong RAM, ghi láº¡i Disk`, 'ok');
      break;
    }

    case 'pass_info':
      phaseBadge.textContent = `LÆ°á»£t trá»™n ${ev.pass_id}`;
      log(`ğŸ”€ LÆ°á»£t trá»™n ${ev.pass_id} â€” ${ev.runs_before} runs, k=${ev.k}`, 'info');
      outputCount = 0;
      break;

    case 'merge_start':{
      ensureMergeZone(ev.pass_id, ev.group_id, ev.inputs);
      // init buffer cards with actual numbers
      if(ev.input_buffers){
        ev.input_buffers.forEach((arr, i)=>{
          getOrCreateBufferCard(ev.pass_id, ev.group_id, i);
          updateBufferCard(ev.pass_id, ev.group_id, i, arr);
        });
      }
      // init heap from initial_heap snapshot
      if(ev.initial_heap && heapNodesEl){
        heapNodesEl.innerHTML = '';
        ev.initial_heap.forEach(h=>{
          const val = Array.isArray(h)?h[0]:h.value;
          const src = Array.isArray(h)?h[1]:h.src;
          pushHeapNode(val, src);
        });
      }
      log(`ğŸ§  Báº¯t Ä‘áº§u merge: pass ${ev.pass_id} nhÃ³m ${ev.group_id}`, 'ram');
      break;
    }

    case 'heap_push':
      ensureCurrentRefs();
      pushHeapNode(ev.value, ev.src);
      break;

    case 'heap_pop':
      ensureCurrentRefs();
      popHeapNode(ev.value, ev.src);
      break;

    case 'output_emit':
      ensureCurrentRefs();
      emitOutput(ev.value);
      // flash transfer arrow disk-write
      if(ev.emitted_count % 5 === 0){
        flashTransfer(`ğŸ’¾ Ghi ${fmt(ev.value)} ra Disk (${ev.emitted_count} pháº§n tá»­)`);
      }
      break;

    case 'input_buffer_update':
      if(ev.input_buffers){
        ev.input_buffers.forEach((arr,i)=>{
          updateBufferCard(currentPassId, currentGroupId, i, arr);
        });
      }
      break;

    case 'merge_end':
      log(`âœ“ Káº¿t thÃºc merge pass ${ev.pass_id} nhÃ³m ${ev.group_id} â€” ${ev.merged_count} pháº§n tá»­`, 'ok');
      break;

    case 'finished':{
      phaseBadge.textContent = 'âœ“ HoÃ n thÃ nh';
      log('ğŸ‰ Visualization hoÃ n thÃ nh!', 'ok');
      // Final output zone
      if(ev.final_preview?.length){
        const finZone = document.createElement('div');
        finZone.className = 'zone zone-disk';
        finZone.style.borderColor = 'rgba(34,211,160,.5)';
        finZone.innerHTML = `
          <div class="zone-header">
            <span class="zone-icon">âœ…</span>
            <span class="zone-title" style="color:var(--green)">Disk â€” Káº¿t quáº£ cuá»‘i (Ä‘Ã£ sáº¯p xáº¿p)</span>
            <span class="zone-desc">${ev.final_preview.length} sá»‘ (preview)</span>
          </div>
          <div class="output-wrap" style="border-color:rgba(34,211,160,.4)">
            <div class="output-title"><span>Output sorted</span></div>
            <div class="output-numbers" style="color:var(--green);max-height:80px;overflow:auto">
              ${ev.final_preview.map(v=>`<span>${fmt(v)}</span>`).join('  ')}
            </div>
          </div>`;
        stageContent.appendChild(finZone);
        stageContent.scrollTop = stageContent.scrollHeight;
      }
      paused = true;
      pauseBtn.textContent = 'â¸ Pause';
      pauseBtn.disabled    = true;
      break;
    }
  }
}

// â”€â”€ Playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(){
  if(paused || idx >= steps.length) return;
  processEvent(steps[idx++]);
  updateProgress();
  setTimeout(tick, Math.max(30, 380/speed));
}

startBtn.onclick = ()=>{
  paused = false;
  startBtn.disabled = true;
  pauseBtn.disabled = false;
  pauseBtn.textContent = 'â¸ Pause';
  tick();
};
pauseBtn.onclick = ()=>{
  paused = !paused;
  pauseBtn.textContent = paused ? 'â–¶ Resume' : 'â¸ Pause';
  if(!paused) tick();
};
stepBtn.onclick = ()=>{
  if(!paused){ paused=true; pauseBtn.textContent='â–¶ Resume'; }
  if(idx < steps.length){ processEvent(steps[idx++]); updateProgress(); }
};
speedInput.oninput = ()=>{ speed=parseFloat(speedInput.value); speedLabel.textContent=speed+'Ã—'; };

document.addEventListener('keydown', e=>{
  if(e.target.tagName==='INPUT') return;
  if(e.code==='Space'){ e.preventDefault(); paused?startBtn.disabled?pauseBtn.click():startBtn.click():pauseBtn.click(); }
  if(e.key==='ArrowRight') stepBtn.click();
});
</script>
</body>
</html>