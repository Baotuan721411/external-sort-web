<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>External Merge Sort Visualizer</title>

<style>
body{
    background:#0f172a;
    color:white;
    text-align:center;
    font-family:Arial;
}
.bar{
    width:18px;
    background:#38bdf8;
    margin:2px;
    display:inline-block;
}
.buffer{
    border:2px solid #22c55e;
    width:90px;
    height:120px;
    margin:5px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
}
.heap-node{
    background:#f59e0b;
    padding:6px 10px;
    border-radius:8px;
    margin:3px;
    display:inline-block;
}
</style>
</head>

<body>

<h1>External Merge Sort Visualizer</h1>

<input type="file" id="fileInput">
<button onclick="uploadFile()">Upload & Sort</button>

<h3 id="config"></h3>

<div id="buffers"></div>
<div id="heap"></div>
<div id="bars"></div>

<br>
<a id="download" style="display:none">â¬‡ Download sorted.bin</a>

<script>
let jobId=null;
let steps=[];
let index=0;

async function uploadFile(){
    const file=document.getElementById("fileInput").files[0];
    const fd=new FormData();
    fd.append("file",file);

    const res=await fetch("/sort",{method:"POST",body:fd});
    const data=await res.json();
    jobId=data.job_id;

    checkStatus();
}

async function checkStatus(){
    const res=await fetch(`/status/${jobId}`);
    const data=await res.json();

    if(data.status!=="done"){
        setTimeout(checkStatus,2000);
        return;
    }

    const stepsRes=await fetch(`/steps/${jobId}`);
    const s=await stepsRes.json();

    steps=s.steps;
    const meta=s.meta;

    document.getElementById("config").innerHTML=
        `k = ${meta.k} | block_size = ${meta.block_size}`;

    drawBuffers(meta.k);

    document.getElementById("download").href=`/download/${jobId}`;
    document.getElementById("download").style.display="inline";

    visualize();
}

function drawBuffers(k){
    const b=document.getElementById("buffers");
    b.innerHTML="";
    for(let i=0;i<k;i++){
        const div=document.createElement("div");
        div.className="buffer";
        div.innerText="Buffer "+(i+1);
        b.appendChild(div);
    }
}

function drawHeap(arr){
    const h=document.getElementById("heap");
    h.innerHTML="";
    arr.slice(0,20).forEach(v=>{
        const n=document.createElement("div");
        n.className="heap-node";
        n.innerText=v.toFixed(2);
        h.appendChild(n);
    });
}

function drawBars(arr){
    const b=document.getElementById("bars");
    b.innerHTML="";
    let max=Math.max(...arr);
    arr.forEach(v=>{
        const bar=document.createElement("div");
        bar.className="bar";
        bar.style.height=(v/max*200)+"px";
        b.appendChild(bar);
    });
}

function visualize(){
    if(index>=steps.length) return;

    const step=steps[index];

    if(step.type==="merge"){
        drawHeap(step.result);
        drawBars(step.result);
    }

    index++;
    setTimeout(visualize,700);
}
</script>

</body>
</html>