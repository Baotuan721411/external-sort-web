<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>External Merge Sort Visualizer</title>

<style>
body{
    font-family: Arial, Helvetica, sans-serif;
    background: #0f172a;
    color: white;
    text-align: center;
    padding-top: 50px;
}

.container{
    width: 700px;
    margin: auto;
    background: #1e293b;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 0 30px rgba(0,0,0,0.4);
}

button{
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    background: #22c55e;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

button:hover{
    background: #16a34a;
}

#status{
    margin-top: 20px;
    font-size: 18px;
}

#download{
    display:none;
    margin-top: 25px;
}

.bar-container{
    margin-top:40px;
    height:260px;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    gap:6px;
}

.bar{
    width:18px;
    background:#38bdf8;
    transition:height 0.5s, background 0.4s;
    border-radius:4px 4px 0 0;
}

.bar.sorted{
    background:#22c55e;
}

.bar.merge{
    background:#f59e0b;
}

#phase{
    margin-top:20px;
    font-size:20px;
    color:#facc15;
}
</style>
</head>

<body>

<div class="container">
<h1>External Merge Sort Visualizer</h1>

<input type="file" id="fileInput">
<br><br>
<button onclick="uploadFile()">Upload & Sort</button>

<div id="status"></div>
<div id="phase"></div>

<div class="bar-container" id="bars"></div>

<div id="download">
    <p>File ƒë√£ s·∫Øp x·∫øp xong!</p>
    <a id="downloadLink">‚¨á T·∫£i file sorted.bin</a>
</div>
</div>

<script>

let jobId=null;
let steps=[];
let stepIndex=0;

/* ================= UPLOAD ================= */

async function uploadFile(){
    const fileInput=document.getElementById("fileInput");
    const statusDiv=document.getElementById("status");

    if(fileInput.files.length===0){
        alert("Ch·ªçn file tr∆∞·ªõc!");
        return;
    }

    statusDiv.innerHTML="ƒêang upload...";

    let formData=new FormData();
    formData.append("file",fileInput.files[0]);

    const response=await fetch("/sort",{method:"POST",body:formData});
    const data=await response.json();

    jobId=data.job_id;

    statusDiv.innerHTML="ƒêang s·∫Øp x·∫øp tr√™n server...";
    checkStatus();
}

/* ================= CHECK STATUS ================= */

async function checkStatus(){
    const statusDiv=document.getElementById("status");
    const downloadDiv=document.getElementById("download");
    const downloadLink=document.getElementById("downloadLink");

    const res=await fetch(`/status/${jobId}`);
    const data=await res.json();

    if(data.status==="processing"||data.status==="queued"){
        setTimeout(checkStatus,3000);
    }
    else if(data.status==="done"){
        statusDiv.innerHTML="ƒêang t·∫£i d·ªØ li·ªáu m√¥ ph·ªèng...";
        downloadLink.href=`/download/${jobId}`;

        // L·∫§Y FILE STEPS.JSON
        const stepsRes=await fetch(`/steps/${jobId}`);
        const stepsData=await stepsRes.json();
        steps=stepsData.steps;

        statusDiv.innerHTML="B·∫Øt ƒë·∫ßu m√¥ ph·ªèng...";
        visualize();

        downloadDiv.style.display="block";
    }
    else{
        statusDiv.innerHTML="L·ªói: "+data.status;
    }
}

/* ================= DRAW BARS ================= */

function drawBars(array,color="normal"){
    const container=document.getElementById("bars");
    container.innerHTML="";

    let max=Math.max(...array);

    array.forEach(value=>{
        const bar=document.createElement("div");
        bar.className="bar";

        if(color==="sorted") bar.classList.add("sorted");
        if(color==="merge") bar.classList.add("merge");

        bar.style.height=(value/max*240)+"px";
        container.appendChild(bar);
    });
}

/* ================= VISUALIZE ================= */

<script>
async function visualize(){
    const phase=document.getElementById("phase");

    // ===== FIX QUAN TR·ªåNG =====
    if(!steps || steps.length===0){
        phase.innerHTML="‚ö† Kh√¥ng c√≥ d·ªØ li·ªáu m√¥ ph·ªèng (steps r·ªóng)";
        console.log("Steps nh·∫≠n ƒë∆∞·ª£c:",steps);
        return;
    }

    if(stepIndex>=steps.length){
        phase.innerHTML="‚úî ƒê√£ ch·∫°y h·∫øt animation";
        return;
    }

    let step=steps[stepIndex];

    // tr√°nh crash
    if(!step){
        console.log("Step undefined t·∫°i index:",stepIndex);
        return;
    }

    if(step.type==="read_block"){
        phase.innerHTML="üìÇ ƒê·ªçc block t·ª´ file";
        drawBars(step.data);
    }

    else if(step.type==="sort_block"){
        phase.innerHTML="üß† S·∫Øp x·∫øp trong RAM (Internal Sort)";
        drawBars(step.data,"sorted");
    }

    else if(step.type==="merge"){
        phase.innerHTML="üîÄ ƒêang Merge c√°c Run";
        drawBars(step.result,"merge");
    }

    else if(step.type==="finished"){
        phase.innerHTML="‚úÖ Ho√†n t·∫•t External Merge Sort!";
        drawBars(step.data,"sorted");
        return;
    }

    stepIndex++;
    setTimeout(visualize,1000);
}
</script>
</body>
</html>